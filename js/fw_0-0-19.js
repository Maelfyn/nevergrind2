(function($,Math,document,location){$.ajaxSetup({type:'POST',timeout:5000});TweenMax.defaultEase=Quad.easeOut;var g={defaultTitle:'Firmament Wars | Multiplayer Grand Strategy Warfare',titleFlashing:false,name:"",password:"",focusUpdateNationName:false,focusGameName:false,view:"title",resizeX:1,resizeY:1,sfxFood:false,sfxCulture:false,chatOn:false,overlay:document.getElementById("overlay"),over:0,done:0,startTime:Date.now(),keyLock:false,loadAttempts:0,upgradeCost:[80,140,200],isModalOpen:false,lock:function(clear){g.overlay.style.display="block";clear?g.overlay.style.opacity=0:g.overlay.style.opacity=1;g.keyLock=true;},unlock:function(clear){g.overlay.style.display="none";clear?g.overlay.style.opacity=0:g.overlay.style.opacity=1;g.keyLock=false;},unlockFade:function(d){if(!d){d=1;}
TweenMax.to(g.overlay,d,{startAt:{opacity:1,},ease:Power3.easeIn,opacity:0,onComplete:function(){g.overlay.style.display='none';}});},TDC:function(){return new TweenMax.delayedCall(0,'');},screen:{fullScreen:true,width:window.innerWidth,height:window.innerHeight,resizeMap:function(){$("#mapStyle").remove();var css='<style id="mapStyle">#worldWrap{ '+'position: absolute; '+'top: 0%; '+'left: 0%; '+'width: '+((g.map.sizeX / window.innerWidth)*100)+'%; '+'height: '+((g.map.sizeY / window.innerHeight)*100)+'%; '+'}</style>';if(css){$DOM.head.append(css);}}},mouse:{zoom:100,mouseTransX:50,mouseTransY:50},map:{sizeX:2000,sizeY:1000,name:'Earth Alpha',key:'EarthAlpha',tiles:83},updateUserInfo:function(){if(location.host!=='localhost'){$.ajax({async:true,type:'GET',dataType:'jsonp',url:'https://geoip-db.com/json/geoip.php?jsonp=?'}).done(function(data){data.latitude+='';data.longitude+='';g.geo=data;localStorage.setItem('geo',JSON.stringify(g.geo));$.ajax({url:'php/updateUserInfo.php',data:{location:g.geo}});var foo=JSON.parse(geo);g.config.location=foo.location;console.info('loc: ',g.config.location);});}},checkPlayerData:function(){var geo=localStorage.getItem('geo');if(geo===null){g.updateUserInfo();}},config:{audio:{musicVolume:50,soundVolume:50}},geo:{},keepAlive:function(){$.ajax({type:'GET',url:"php/keepAlive.php"}).always(function(){setTimeout(g.keepAlive,300000);});},removeContainers:function(){$("#firmamentWarsLogoWrap, #mainWrap").remove();},notification:{},sendNotification:function(msg){if(!document.hasFocus()&&g.view!=='game'){var type='says';if(msg.indexOf("images/flags")>-1){var flagArr=msg.split('"'),flagPath=flagArr[1],bodyArr=msg.split(':'),body=bodyArr[1],msgArr=bodyArr[0].split('>');my.lastReceivedWhisper=msgArr[1];var msg=my.lastReceivedWhisper+' says:';if(my.lastReceivedWhisper.indexOf(' whispers')>-1){msg=my.lastReceivedWhisper+':';my.lastReceivedWhisper=my.lastReceivedWhisper.split(" ").shift();type='whispers';}
if(my.lastReceivedWhisper){g.notification=new Notification(msg,{icon:flagPath,tag:"Nevergrind",body:body});g.notification.onclick=function(){window.focus();}}}
if(!g.titleFlashing&&my.lastReceivedWhisper){g.titleFlashing=true;(function repeat(toggle){if(!document.hasFocus()){if(toggle%2===0){document.title=my.lastReceivedWhisper+' '+type+'...';}else{document.title=g.defaultTitle;}
setTimeout(repeat,3000,++toggle);}})(0);}
audio.play('chat');}},chat:function(msg,type){window[g.view].chat(msg,type);}}
g.init=(function(){console.info("Initializing game...");$('[title]').tooltip();var s="<li><a class='flagSelect'>Default</a></li>";var flagData={Africa:{group:"Africa",name:['Algeria','Botswana','Cameroon','Cape Verde','Ivory Coast','Egypt','Ghana','Kenya','Liberia','Morocco','Mozambique','Namibia','Nigeria','South Africa','Uganda']},Asia:{group:"Asia",name:['Bangladesh','Cambodia','China','Hong Kong','India','Indonesia','Iran','Japan','Malaysia','Mongolia','Myanmar','Nepal','North Korea','Pakistan','Philippines','Singapore','South Korea','Sri Lanka','Suriname','Taiwan','Thailand','Vietnam']},Europe:{group:"Europe",name:['Albania','Austria','Belgium','Bosnia and Herzegovina','Bulgaria','Croatia','Czech Republic','Denmark','England','Estonia','Finland','France','Germany','Greece','Hungary','Iceland','Ireland','Italy','Kosovo','Latvia','Lithuania','Macedonia','Montenegro','Netherlands','Norway','Poland','Portugal','Romania','Russia','Scotland','Serbia','Slovakia','Slovenia','Spain','Sweden','Switzerland','Ukraine','United Kingdom']},Eurasia:{group:"Eurasia",name:['Armenia','Azerbaijan','Georgia','Kazakhstan','Uzbekistan']},Historic:{group:"Historic",name:['Confederate Flag','Flanders','Gadsden Flag','Isle of Man','Rising Sun Flag','NSDAP Flag','NSDAP War Ensign','Shahanshahi','USSR','Welsh']},MiddleEast:{group:"Middle East",name:['Israel','Jordan','Kurdistan','Lebanon','Palestine','Qatar','Saudi Arabia','Syria','Turkey']},NorthAmerica:{group:"North America",name:['Bahamas','Barbados','Canada','Costa Rica','Cuba','Haiti','Honduras','Mexico','Saint Lucia','Trinidad and Tobago','United States']},Oceania:{group:"Oceania",name:['Australia','New Zealand']},Miscellaneous:{group:"Miscellaneous",name:['Anarcho-Capitalist','Christian','Edgemaster','European Union','High Energy','ISIS','Northwest Front','Pan-African Flag','Rainbow Flag','United Nations']},SouthAmerica:{group:"South America",name:['Argentina','Bolivia','Brazil','Chile','Colombia','Ecuador','Paraguay','Peru','Uruguay','Venezuela']},}
for(var key in flagData){s+="<li class='dropdown-header'>"+flagData[key].group+"</li>";flagData[key].name.forEach(function(e){s+="<li><a class='flagSelect' href='#'>"+e+"</a></li>";});}
document.getElementById("flagDropdown").innerHTML=s;if(location.hostname==='localhost'){$.ajax({type:"GET",url:'php/rejoinGame.php'}).done(function(data){console.info('rejoin ',data);if(data.gameId>0){console.info("Auto joined game:"+(data.gameId));my.player=data.player;game.id=data.gameId;g.map=data.mapData;setTimeout(function(){lobby.init(data);lobby.join(0);initResources(data);my.government=data.government;lobby.updateGovernmentWindow(my.government);socket.joinGame();},111);}}).fail(function(data){Msg(data.responseText);}).always(function(){g.unlock();});}})();var game={name:'',tiles:[],initialized:false,player:[0,0,0,0,0,0,0,0,0],updateTopTile:function(i){document.getElementById('topTile').setAttributeNS('http://www.w3.org/1999/xlink','xlink:href','#land'+i);},stats:{duration:Date.now(),player:[],init:(function(totalPlayers){setTimeout(function(){for(var i=1;i<totalPlayers;i++){game.stats.player[i]=new Stats();}});})(8)},chat:function(msg,type){while(DOM.chatContent.childNodes.length>10){DOM.chatContent.removeChild(DOM.chatContent.firstChild);}
var z=document.createElement('div');if(type){z.className=type;}
z.innerHTML=msg;DOM.chatContent.appendChild(z);setTimeout(function(){if(z!==undefined){if(z.parentNode!==null){z.parentNode.removeChild(z);}}},12000);},alivePlayers:function(){var count=0;for(var i=0,len=game.player.length;i<len;i++){if(game.player[i].account){if(game.player[i].alive){count++;}}}
return count;},eliminatePlayer:function(data){var i=data.player;game.player[i].alive=false;if($(".alive").length>1){$("#diplomacyPlayer"+i).removeClass('alive');var playerLen=$(".alive").length;if(playerLen<2){g.done=1;if(!g.over){if(i===my.player){gameDefeat();}else if(game.alivePlayers()===1){gameVictory();}}}
TweenMax.to('#diplomacyPlayer'+i,1,{autoAlpha:0,onComplete:function(){$("#diplomacyPlayer"+i).css('display','none');}});}},startGameState:function(){game.getGameState();setInterval(game.updateResources,5000);delete game.startGameState;},getGameState:function(){$.ajax({type:"GET",url:"php/getGameState.php"}).done(function(data){for(var i=0,len=data.tiles.length;i<len;i++){var d=data.tiles[i],updateTargetStatus=false;if(d.player!==game.tiles[i].player){if(!game.tiles[i].units){TweenMax.set(document.getElementById('unit'+i),{visibility:'visible'});}
game.tiles[i].player=d.player;game.tiles[i].account=game.player[d.player].account;game.tiles[i].nation=game.player[d.player].nation;game.tiles[i].flag=game.player[d.player].flag;if(my.tgt===i){updateTargetStatus=true;}
var newFlag=!game.player[d.player].flag?'blank.png':game.player[d.player].flag;var e5=document.getElementById('flag'+i);if(e5!==null){e5.href.baseVal="images/flags/"+newFlag;}
TweenMax.set(document.getElementById('land'+i),{fill:color[d.player]});}
if(d.units!==game.tiles[i].units){var unitColor=d.units>game.tiles[i].units?'#00ff00':'#ff0000';game.tiles[i].units=d.units;if(my.tgt===i){updateTargetStatus=true;}
setTileUnits(i,unitColor);if(d.player){TweenMax.to(".mapBars"+i,1,{opacity:1,ease:Linear.easeNone});}}
if(updateTargetStatus){showTarget(document.getElementById('land'+i));game.updateTopTile(i);}}}).fail(function(data){console.info(data.responseText);});},updateDefense:function(data){var i=data.tile;game.tiles[i].defense=data.defense;animate.updateMapBars(i);if(my.tgt===i){showTarget(document.getElementById('land'+my.tgt));}},updateTile:function(d){var i=d.tile,p=d.player;if(!game.tiles[i].units){TweenMax.set(document.getElementById('unit'+i),{visibility:'visible'});}
game.tiles[i].player=p;game.tiles[i].account=game.player[p].account;game.tiles[i].nation=game.player[p].nation;game.tiles[i].flag=game.player[p].flag;var newFlag=!game.player[p].flag?'blank.png':game.player[p].flag;var flag=document.getElementById('flag'+i);if(flag!==null){flag.href.baseVal="images/flags/"+newFlag;}
var land=document.getElementById('land'+i);TweenMax.set(land,{fill:color[p]});if(d.units){if(d.units!==game.tiles[i].units){var unitColor=d.units>game.tiles[i].units?'#00ff00':'#ff0000';game.tiles[i].units=d.units;setTileUnits(i,unitColor);if(p){TweenMax.to(".mapBars"+i,1,{opacity:1,ease:Linear.easeNone});}}}
if(my.tgt===i){showTarget(land);game.updateTopTile(i);}},updateResources:function(){if(!g.over){$.ajax({type:"GET",url:"php/updateResources.php"}).done(function(data){console.info('resource: ',data);setResources(data);if(data.cultureMsg!==undefined){if(data.cultureMsg){game.chat(data.cultureMsg);audio.play('culture');initOffensiveTooltips();}}
if(data.get!==undefined){if(!data.getBonus){game.chat(data.get+': '+my.nation+' receives <span class="chat-manpower">'+data.manpowerBonus+'</span> armies!');audio.play('food');}}}).fail(function(data){console.info(data.responseText);serverError(data);});}}}
var my={lastReceivedWhisper:'',account:'',channel:'global',player:1,gameName:'Earth Alpha',max:8,tgt:1,lastTgt:1,capital:0,lastTarget:{},units:0,food:0,production:25,culture:0,oBonus:-1,dBonus:-1,turnBonus:-1,foodBonus:-1,cultureBonus:-1,turnProduction:10,foodMax:25,cultureMax:400,manpower:0,focusTile:0,sumFood:0,sumProduction:0,sumCulture:0,flag:"",targetLine:[0,0,0,0,0,0],motionPath:[0,0,0,0,0,0],attackOn:false,splitAttack:false,splitAttackCost:5,attackCost:10,deployCost:10,recruitCost:30,weaponCost:1,maxDeployment:24,buildCost:1,targetData:{},selectedFlag:"Default",selectedFlagFull:"Default.jpg",government:'Despotism',tech:{engineering:0,gunpowder:0,rocketry:0,atomicTheory:0},hud:function(msg,d){timer.hud.kill();DOM.hud.style.visibility='visible';DOM.hud.textContent=msg;if(d){timer.hud=TweenMax.to(DOM.hud,5,{onComplete:function(){DOM.hud.style.visibility='hidden';}});}},clearHud:function(){timer.hud.kill();DOM.hud.style.visibility='hidden';TweenMax.set([DOM.targetLine,DOM.targetLineShadow,DOM.targetCrosshair],{visibility:'hidden',strokeDashoffset:0});$DOM.head.append('<style>.land{ cursor: pointer; }</style>');},nextTarget:function(backwards){my.lastTgt=my.tgt;var count=0,len=game.tiles.length;backwards?my.tgt--:my.tgt++;if(my.tgt<0){my.tgt=len-1;}
while(count<255&&my.player!==game.tiles[my.tgt%len].player){backwards?my.tgt--:my.tgt++;if(my.tgt<0){my.tgt=len-1;}
count++;}
if(!backwards){my.tgt=my.tgt%len;}else{my.tgt=Math.abs(my.tgt);}
my.focusTile(my.tgt,.1);animate.glowTile(my.lastTgt,my.tgt);},focusTile:function(tile,d){var e=document.getElementById("land"+tile),box=e.getBBox();if(d===undefined){d=.5;}
var x=-box.x+512;if(x>0){x=0;}
var xMin=(g.map.sizeX-g.screen.width)*-1;if(x<xMin){x=xMin;}
var y=-box.y+234;if(y>0){y=0;}
var yMin=(g.map.sizeY-g.screen.height)*-1;if(y<yMin){y=yMin;}
TweenMax.to(DOM.worldWrap,d,{force3D:false,x:x*g.resizeX,y:y*g.resizeY});showTarget(document.getElementById('land'+tile),false,1);my.flashTile(tile);},flashTile:function(tile){if(!my.attackOn){if(game.tiles[tile].units){var e2=document.getElementById('unit'+tile);TweenMax.to(e2,.05,{startAt:{transformOrigin:'50% 50%',fill:'#0ff'},fill:'#ffffff',ease:SteppedEase.config(1),repeat:6,yoyo:true});TweenMax.set(e2,{visibility:'visible'});}}},inlineFlag:function(){return'<img src="images/flags/'+my.flag+'" class="inlineFlag">';}}
var timer={hud:g.TDC()}
var DOM;function initDom(){var d=document;DOM={gameTableBody:d.getElementById('gameTableBody'),food:d.getElementById('food'),production:d.getElementById('production'),culture:d.getElementById('culture'),Msg:d.getElementById('Msg'),hud:d.getElementById("hud"),sumFood:d.getElementById("sumFood"),foodMax:d.getElementById("foodMax"),cultureMax:d.getElementById("cultureMax"),manpower:d.getElementById("manpower"),sumProduction:d.getElementById("sumProduction"),sumCulture:d.getElementById("sumCulture"),chatContent:d.getElementById("chat-content"),chatInput:d.getElementById("chat-input"),lobbyChatInput:d.getElementById("lobby-chat-input"),titleChatInput:d.getElementById("title-chat-input"),worldWrap:d.getElementById('worldWrap'),motionPath:d.getElementById('motionPath'),targetLine:d.getElementById('targetLine'),targetLineShadow:d.getElementById('targetLineShadow'),targetCrosshair:d.getElementById('targetCrosshair'),target:d.getElementById('target'),targetFlag:d.getElementById('targetFlag'),targetName:d.getElementById('targetName'),oBonus:d.getElementById('oBonus'),dBonus:d.getElementById('dBonus'),turnBonus:d.getElementById('turnBonus'),foodBonus:d.getElementById('foodBonus'),cultureBonus:d.getElementById('cultureBonus'),foodBar:d.getElementById('foodBar'),cultureBar:d.getElementById('cultureBar'),world:d.getElementById('world'),bgmusic:d.getElementById('bgmusic'),tileName:d.getElementById('tileName'),tileActions:d.getElementById('tileActions'),buildWord:d.getElementById('buildWord'),buildCost:d.getElementById('buildCost'),cannonsCost:d.getElementById('cannonsCost'),missileCost:d.getElementById('missileCost'),nukeCost:d.getElementById('nukeCost'),gunpowderCost:d.getElementById('gunpowderCost'),engineeringCost:d.getElementById('engineeringCost'),rocketryCost:d.getElementById('rocketryCost'),atomicTheoryCost:d.getElementById('atomicTheoryCost'),futureTechCost:d.getElementById('futureTechCost'),upgradeTileDefense:d.getElementById('upgradeTileDefense'),screenFlash:d.getElementById('screenFlash'),fireCannons:d.getElementById('fireCannons'),launchMissile:d.getElementById('launchMissile'),launchNuke:d.getElementById('launchNuke'),researchEngineering:d.getElementById('researchEngineering'),researchGunpowder:d.getElementById('researchGunpowder'),researchRocketry:d.getElementById('researchRocketry'),researchAtomicTheory:d.getElementById('researchAtomicTheory'),researchFutureTech:d.getElementById('researchFutureTech'),lobbyChatLog:d.getElementById('lobbyChatLog'),titleChatLog:d.getElementById('titleChatLog'),mapAnimations:d.getElementById('mapAnimations'),mapCapitals:d.getElementById('mapCapitals'),mapUpgrades:d.getElementById('mapUpgrades'),mapBars:d.getElementById('mapBars'),titleChatBody:d.getElementById('titleChatBody')}}
initDom();var $DOM={head:$("#head"),chatInput:$("#chat-input"),lobbyChatInput:$("#lobby-chat-input"),titleChatInput:$("#title-chat-input")}
var color=["#002F73","#700000","#0000d0","#b0b000","#006000","#b06000","#1177aa","#b050b0","#5500aa"]
var worldMap=[];function checkMobile(){var x=false;if(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|ipad|iris|kindle|Android|Silk|lge |maemo|midp|mmp|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino/i.test(navigator.userAgent)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(navigator.userAgent.substr(0,4)))x=true;return x;}
var isXbox=/Xbox/i.test(navigator.userAgent),isPlaystation=navigator.userAgent.toLowerCase().indexOf("playstation")>=0,isNintendo=/Nintendo/i.test(navigator.userAgent),isMobile=checkMobile(),isOpera=!!window.opera||navigator.userAgent.indexOf(' OPR/')>=0,isFirefox=typeof InstallTrigger!=='undefined',isSafari=Object.prototype.toString.call(window.HTMLElement).indexOf('Constructor')>0,isChrome=!!window.chrome&&!isOpera,isMSIE=/*@cc_on!@*/ false,isMSIE11=!!navigator.userAgent.match(/Trident\/7\./);(function($){if(isMSIE||isMSIE11){alert("Firmament Wars does not support Internet Explorer. Consider using Chrome or Firefox for an enjoyable experience.");window.stop();}else if(isSafari){alert("Firmament Wars does not support Safari. Consider using Chrome or Firefox for an enjoyable experience.");window.stop();}
if(isMobile){window.stop();alert("Firmament Wars is currently not available on mobile devices. Sorry about that! It runs like trash on mobile, so I'm probably doing you a favor.");}})($);function resizeWindow(){var e=document.getElementById('body'),winWidth=window.innerWidth,winHeight=window.innerHeight;if(g.screen.fullScreen){g.screen.width=winWidth;g.screen.height=winHeight;g.screen.resizeMap();}
var widthToHeight=g.screen.width / g.screen.height;var w=winWidth>g.screen.width?g.screen.width:winWidth;var h=winHeight>g.screen.height?g.screen.height:winHeight;if(w / h>widthToHeight){w=h*widthToHeight;e.style.height=h+'px';e.style.width=w+'px';}else{h=w / widthToHeight;e.style.width=w+'px';e.style.height=h+'px';}
TweenMax.set("body",{x:~~(w/2+((winWidth-w)/ 2)),y:~~(h/2+((winHeight-h)/ 2)),opacity:1,yPercent:-50,xPercent:-50,force3D:true});e.style.visibility="visible";if(typeof worldMap[0]!=='undefined'){worldMap[0].applyBounds();}
g.resizeX=w / g.screen.width;g.resizeY=h / g.screen.height;TweenMax.set("#worldTitle",{xPercent:-50,yPercent:-50});}
var video={cache:{},load:{game:function(){var x=['missile.png','nuke.png','smoke.png','goldSmoke.png','bulwark.png'];for(var i=0,len=x.length;i<len;i++){var z=x[i];video.cache[z]=new Image();video.cache[z].src="images/"+z;}}}}
function Msg(msg,d){DOM.Msg.innerHTML=msg;if(!d||d<.5){d=2;}
TweenMax.to(DOM.Msg,d,{overwrite:1,startAt:{opacity:1},onComplete:function(){TweenMax.to(this.target,.5,{opacity:0});}});var tl=new TimelineMax();var split=new SplitText(DOM.Msg,{type:"words,chars"});var chars=split.chars;tl.staggerFromTo(chars,.01,{immediateRender:true,alpha:0},{delay:.1,alpha:1},.01);}
function playerLogout(){g.lock();$.ajax({type:'GET',url:'php/logout.php'}).done(function(data){location.reload();}).fail(function(){Msg("Logout failed.");});}
function exitGame(bypass){if(g.view==='game'){var r=confirm("Are you sure you want to surrender?");}
if(r||bypass||g.view!=='game'){g.lock(1);$.ajax({url:'php/exitGame.php',data:{view:g.view}}).always(function(){location.reload();});}}
function serverError(data){console.error('The server reported an error.');}
var title={players:[],games:[],init:(function(){console.info("Initializing title screen...");$("#titleChatLog").on('mousedown',function(){title.chatDrag=true;}).on('mouseup',function(){title.chatDrag=false;});$("#title-chat-input").on('focus',function(){title.chatOn=true;}).on('blur',function(){title.chatOn=false;});$(".createGameInput").on('focus',function(){title.createGameFocus=true;}).on('blur',function(){title.createGameFocus=false;});$("#titleChatSend").on('click',function(){title.sendMsg(true);});$.ajax({type:'GET',url:'php/initChatId.php'}).done(function(data){my.account=data.account;my.flag=data.flag;title.updatePlayers();});setTimeout(function(){var str='';for(var key in title.mapData){str+="<li><a class='mapSelect' href='#'>"+title.mapData[key].name+"</a></li>";}
var e1=document.getElementById('mapDropdown');if(e1!==null){e1.innerHTML=str;}
$('[title]').tooltip();title.animateLogo();},200);Notification.requestPermission();$.ajax({type:'GET',url:'php/refreshGames.php'}).done(function(data){var e=document.getElementById('gameTableBody');if(e===null){return;}
var str='';for(var i=0,len=data.length;i<len;i++){var d=data[i];title.games[d.id]=d.players*1;str+="<tr id='game_"+d.id+"' class='wars no-select' data-name='"+d.name+"'>     <td class='warCells'>"+d.name+"</td>     <td class='warCells'>"+d.map+"</td>     <td class='warCells'><span id='game_players_"+d.id+"'>"+d.players+"</span>/"+d.max+"</td>    </tr>";}
e.innerHTML=str;$(".wars").filter(":first").trigger("click");}).fail(function(e){console.info(e.responseText);Msg("Server error.");});})(),updatePlayers:function(data){title.titleUpdate=$("#titleChatPlayers").length;if(title.titleUpdate){(function repeat(){if(g.view==='title'){var start=Date.now();$.ajax({type:"POST",url:"php/titleUpdate.php",data:{channel:my.channel}}).done(function(data){console.log("Ping: ",Date.now()-start,data);if(data.playerData!==undefined){var p=data.playerData,foundPlayers=[];for(var i=0,len=p.length;i<len;i++){var account=p[i].account,flag=p[i].flag;if(title.players[account]===undefined){title.addPlayer(account,flag);}else if(title.players[account].flag!==flag){var flagElement=document.getElementById("titlePlayerFlag_"+account);if(flagElement!==null){flagElement.src='images/flags/'+flag;}}
foundPlayers.push(account);}
for(var key in title.players){if(foundPlayers.indexOf(key)===-1){var x={account:key}
title.removePlayer(x);}}}
document.getElementById('titleChatHeaderCount').textContent=len;var serverGames=[];if(data.gameData!==undefined){var p=data.gameData;for(var i=0,len=p.length;i<len;i++){serverGames[p[i].id]={players:p[i].players*1,max:p[i].max*1}}}
title.games.forEach(function(e,ind){if(serverGames[ind]===undefined){var o={id:ind}
title.removeGame(o);}else{if(serverGames[ind].players!==title.games[ind]){var o={id:ind,players:serverGames[ind].players,max:serverGames[ind].max}
title.setToGame(o);}}});}).always(function(){setTimeout(repeat,5000);});}})();}else{$("#titleChat, #titleMenu").remove();}},addPlayer:function(account,flag){title.players[account]={flag:flag}
var e=document.createElement('div');e.className="titlePlayer";e.id="titlePlayer"+account;var flagName=flag.split(".");e.innerHTML='<img id="titlePlayerFlag_'+account+'" class="inlineFlag" src="images/flags/'+flag+'"> '+account;if(title.titleUpdate){DOM.titleChatBody.appendChild(e);}},removePlayer:function(data){delete title.players[data.account];var z=document.getElementById('titlePlayer'+data.account);if(z!==null){z.parentNode.removeChild(z);}},updateGame:function(data){if(data.type==='addToGame'){title.addToGame(data);}else if(data.type==='removeFromGame'){title.removeFromGame(data);}else if(data.type==='addGame'){title.addGame(data);}else if(data.type==='removeGame'){title.removeGame(data);}},updatePlayerText:function(id){var e=document.getElementById('game_players_'+id);if(e!==null){e.textContent=title.games[id];}},setToGame:function(data){var id=data.id;title.games[id]=data.players;title.updatePlayerText(id);},addToGame:function(data){var id=data.id;if(title.games[id]!==undefined){if(title.games[id]+1>data.max){title.games[id]=data.max;}else{title.games[id]++;}}else{title.games[id]=1;}
title.updatePlayerText(id);},removeFromGame:function(data){var id=data.id;if(title.games[id]!==undefined){if(title.games[id]-1<1){title.games[id]=1;}else{title.games[id]--;}}else{title.games[id]=1;}
title.updatePlayerText(id);},addGame:function(data){title.games[data.id]=1;var e=document.createElement('tr');e.id='game_'+data.id;e.className='wars no-select';e.setAttribute('data-name',data.name);e.innerHTML="<td class='warCells'>"+data.name+"</td>   <td class='warCells'>"+data.map+"</td>   <td class='warCells'><span id='game_players_"+data.id+"'>1</span>/"+data.max+"</td>";DOM.gameTableBody.insertBefore(e,DOM.gameTableBody.childNodes[0]);},removeGame:function(data){delete title.games[data.id];var e=document.getElementById('game_'+data.id);if(e!==null){e.parentNode.removeChild(e);}},animateLogo:function(){var globeDelay=1,globeYoyo=6;TweenMax.to('#firmamentWarsStars1',240,{backgroundPosition:'-800px 0px',repeat:-1,ease:Linear.easeNone});TweenMax.to('#firmamentWarsStars2',150,{startAt:{backgroundPosition:'250px 250px',},backgroundPosition:'-1050px 250px',repeat:-1,ease:Linear.easeNone});TweenMax.to('#firmamentWarsStars3',70,{startAt:{backgroundPosition:'600px 500px',},backgroundPosition:'-200px 500px',repeat:-1,ease:Linear.easeNone});TweenMax.to('#firmamentWarsStars4',30,{startAt:{backgroundPosition:'400px 600px',},backgroundPosition:'-400px 600px',repeat:-1,ease:Linear.easeNone});TweenMax.to('#firmamentWarsLogo',globeDelay,{startAt:{visibility:'visible',alpha:0},alpha:1,ease:Quad.easeIn});TweenMax.to('#firmamentWarsLogo',globeDelay,{startAt:{yPercent:-50,y:'-15%'},y:'0%',onComplete:function(){TweenMax.to('#titleMain',.5,{startAt:{visibility:'visible'},opacity:1});}});TweenMax.to('#titleGlobe',globeDelay,{startAt:{y:'15%'},y:'0%'});},mapData:{EarthAlpha:{name:'Earth Alpha',tiles:83,players:8},FlatEarth:{name:'Flat Earth',tiles:78,players:8}},chatDrag:false,chatOn:false,chat:function(msg,type){if(g.view==='title'&&msg){while(DOM.titleChatLog.childNodes.length>500){DOM.titleChatLog.removeChild(DOM.titleChatLog.firstChild);}
var z=document.createElement('div');if(type){z.className=type;}
z.innerHTML=msg;DOM.titleChatLog.appendChild(z);if(!title.chatDrag){DOM.titleChatLog.scrollTop=DOM.titleChatLog.scrollHeight;}
if(type!=='chat-white'){g.sendNotification(msg);}}},chatReceive:function(data){if(g.view==='title'){if(data.type==='remove'){title.removePlayer(data);}else if(data.type==='add'){title.addPlayer(data.account,data.flag);}else{if(data.message!==undefined){title.chat(data.message,data.type);}}}else if(g.view==='lobby'){if(data.type==='hostLeft'){lobby.hostLeft();}else if(data.type==='government'){lobby.updateGovernment(data);}else if(data.type==='countdown'){lobby.countdown(data);}else if(data.type==='update'){lobby.updatePlayer(data);}else{if(data.message!==undefined){lobby.chat(data.message,data.type);}}}else{if(data.type==='cannons'){animate.cannons(data.tile,false);game.updateTile(data);}else if(data.type==='missile'){animate.missile(data.attacker,data.defender,true);}else if(data.type==='nuke'){setTimeout(function(){animate.nuke(data.tile);},5000);}else if(data.type==='nukeHit'){game.updateTile(data);game.updateDefense(data);}else if(data.type==='gunfire'){animate.gunfire(data.tile,data.attacker===my.account);game.updateTile(data);}else if(data.type==='updateTile'){game.updateTile(data);}else if(data.type==='food'){if(data.account.indexOf(my.account)>-1){audio.play('food');}}else if(data.type==='upgrade'){game.updateDefense(data);animate.upgrade(data.tile);}else if(data.type==='eliminated'){game.eliminatePlayer(data);}else if(data.type==='disconnect'){game.eliminatePlayer(data);}
if(data.message){if(data.type==='gunfire'){if(data.defender===my.account){game.chat(data.message,data.type);}}else{game.chat(data.message,data.type);}}
if(data.sfx){audio.play(data.sfx);}}},sendWhisper:function(msg,splitter){var arr=msg.split(splitter);var account=arr[1].split(" ").shift();var splitLen=splitter.length;var accountLen=account.length;var msg=msg.substr(splitLen+accountLen+1);$.ajax({url:'php/insertWhisper.php',data:{account:account,message:msg,action:'send'}});},receiveWhisper:function(msg,type){if(g.view==='title'){title.chat(msg,type);}else if(g.view==='lobby'){lobby.chat(msg,type);}else{game.chat(msg,type);}},changeChannel:function(msg,splitter){var arr=msg.split(splitter);socket.setChannel(arr[1]);},sendMsg:function(bypass){var msg=$DOM.titleChatInput.val().trim();if(bypass||title.chatOn){if(msg){if(msg.indexOf('/join ')===0){title.changeChannel(msg,'/join ');}else if(msg.indexOf('/j ')===0){title.changeChannel(msg,'/j ');}else if(msg.indexOf('/whisper ')===0){title.sendWhisper(msg,'/whisper ');}else if(msg.indexOf('/w ')===0){title.sendWhisper(msg,'/w ');}else{$.ajax({url:'php/insertTitleChat.php',data:{message:msg}});}}
$DOM.titleChatInput.val('');}},hideBackdrop:function(){var e=document.getElementById("configureNation"),e2=document.getElementById("titleViewBackdrop"),e3=document.getElementById('createGameWrap')
e4=document.getElementById('optionsModal');TweenMax.to([e,e2,e3,e4],.2,{alpha:0,ease:Linear.easeNone,onComplete:function(){TweenMax.set(this.target,{visibility:'hidden'});}});g.isModalOpen=false;},createGameFocus:false,createGame:function(){var name=$("#gameName").val(),pw=$("#gamePassword").val(),max=$("#gamePlayers").val()*1;if(name.length<1||name.length>32){Msg("Game name must be at least 4-32 characters.");}else if(max<2||max>8||max%1!==0){Msg("Game must have 2-8 players.");}else{title.hideBackdrop();g.lock(1);audio.play('click');$.ajax({url:'php/createGame.php',data:{name:name,pw:pw,map:title.mapData[g.map.key].name,max:max}}).done(function(data){socket.removePlayer(my.account);my.player=data.player;game.id=data.gameId;game.name=data.gameName;lobby.init(data);lobby.join();socket.joinGame();lobby.styleStartGame();}).fail(function(e){console.info(e.responseText);Msg(e.statusText);g.unlock(1);});}},joinGame:function(){g.name=$("#joinGameName").val();if(!g.name){Msg("Game name is not valid!",1.5);return;}
g.password=$("#joinGamePassword").val();g.lock();audio.play('click');$.ajax({url:'php/joinGame.php',data:{name:g.name,password:g.password}}).done(function(data){socket.removePlayer(my.account);my.player=data.player;game.id=data.id;game.name=data.gameName;g.map=data.mapData;lobby.init(data);lobby.join();socket.joinGame();}).fail(function(data){console.info(data);Msg(data.statusText,1.5);}).always(function(){g.unlock();});},submitNationName:function(){var x=$("#updateNationName").val();g.lock();audio.play('click');$.ajax({url:'php/updateNationName.php',data:{name:x}}).done(function(data){$("#nationName").text(data);animate.nationName();}).fail(function(e){Msg(e.statusText);}).always(function(){g.unlock();});}}
var lobby={data:[{account:''},{account:''},{account:''},{account:''},{account:''},{account:''},{account:''},{account:''},{account:''}],startClassOn:"btn btn-info btn-md btn-block btn-responsive shadow4 lobbyButtons",startClassOff:"btn btn-default btn-md btn-block btn-responsive shadow4 lobbyButtons",totalPlayers:function(){var count=0;for(var i=0,len=lobby.data.length;i<len;i++){if(lobby.data[i].account){count++;}}
return count;},updateGovernmentWindow:function(government){var str='';if(government==="Despotism"){str='<div id="lobbyGovName" class="text-primary">Despotism</div>    <div id="lobbyGovPerks">     <div>3x starting energy</div>     <div>+50% starting armies</div>     <div>Start With a Bunker</div>     <div>Free Split Attack</div>    </div>';}else if(government==="Monarchy"){str='<div id="lobbyGovName" class="text-primary">Monarchy</div>    <div id="lobbyGovPerks">     <div>3x starting culture</div>     <div>+50% culture bonus</div>     <div>Start with Great Tactician</div>     <div>1/2 cost structures</div>    </div>';}else if(government==="Democracy"){str='<div id="lobbyGovName" class="text-primary">Democracy</div>    <div id="lobbyGovPerks">     <div>Unlimited Army Deployment</div>     <div>+50% energy bonus</div>     <div>More great people</div>     <div>Start with a wall</div>    </div>';}else if(government==="Fundamentalism"){str='<div id="lobbyGovName" class="text-primary">Fundamentalism</div>    <div id="lobbyGovPerks">     <div>Overrun ability</div>     <div>Infiltration</div>     <div>Faster growth</div>     <div>1/2 cost Recruit</div>    </div>';}else if(government==="Fascism"){str='<div id="lobbyGovName" class="text-primary">Fascism</div>    <div id="lobbyGovPerks">     <div>Fervor doubles bonus troops</div>     <div>Attack cost reduced 20%</div>     <div>Start with Great General</div>     <div>1/2 cost Deploy</div>    </div>';}else if(government==="Republic"){str='<div id="lobbyGovName" class="text-primary">Republic</div>    <div id="lobbyGovPerks">     <div>+50% plunder bonus</div>     <div>2x starting food</div>     <div>+50% food bonus</div>     <div>Combat medics</div>    </div>';}else if(government==="Communism"){str='<div id="lobbyGovName" class="text-primary">Communism</div>    <div id="lobbyGovPerks">     <div>2x discovery bonus</div>     <div>1/2 cost research</div>     <div>1/2 cost weapons</div>     <div>Start with a great person</div>    </div>';}
document.getElementById('lobbyGovernment'+my.player).innerHTML=government;document.getElementById('lobbyGovernmentDescription').innerHTML=str;},chat:function(msg,type){while(DOM.lobbyChatLog.childNodes.length>200){DOM.lobbyChatLog.removeChild(DOM.lobbyChatLog.firstChild);}
var z=document.createElement('div');if(type){z.className=type;}
z.innerHTML=msg;DOM.lobbyChatLog.appendChild(z);if(!lobby.chatDrag){DOM.lobbyChatLog.scrollTop=DOM.lobbyChatLog.scrollHeight;}
console.info(type);if(type!=='chat-white'){g.sendNotification(msg);}},chatDrag:false,gameStarted:false,chatOn:false,sendMsg:function(bypass){var msg=$DOM.lobbyChatInput.val().trim();if(bypass||lobby.chatOn){if(msg){if(msg.indexOf('/whisper ')===0){title.sendWhisper(msg,'/whisper ');}else if(msg.indexOf('/w ')===0){title.sendWhisper(msg,'/w ');}else{$.ajax({url:'php/insertLobbyChat.php',data:{message:msg}});}}
$DOM.lobbyChatInput.val('');}},init:function(x){console.info("Initializing lobby...");var e1=document.getElementById("lobbyGameName");if(e1!==null){e1.innerHTML=x.name;document.getElementById("lobbyGameMax").innerHTML=x.max;document.getElementById("lobbyGameMap").innerHTML=x.map;var z=x.player===1?"block":"none";document.getElementById("startGame").style.display=z;if(!x.startGame){document.getElementById('mainWrap').style.display="block";}
var str='<div id="lobbyWrap" class="container">';for(var i=1;i<=8;i++){str+='<div id="lobbyRow'+i+'" class="row lobbyRow">     <div class="col-xs-2">      <img id="lobbyFlag'+i+'" data-placement="right" class="lobbyFlags block center p'+i+'b player'+i+'" src="images/flags/blank.png">     </div>     <div class="col-xs-6 lobbyDetails">      <div id="lobbyAccount'+i+'" class="lobbyAccounts"></div>      <div id="lobbyName'+i+'" class="lobbyNames nowrap"></div>     </div>     <div class="col-xs-4">';if(i===x.player){str+='<div class="dropdown govDropdown">       <button class="btn btn-primary dropdown-toggle shadow4 fwDropdownButton" type="button" data-toggle="dropdown">        <span id="lobbyGovernment'+i+'">Despotism</span>        <i class="fa fa-caret-down text-warning lobbyCaret"></i>       </button>       <ul id="governmentDropdown" class="dropdown-menu">        <li class="governmentChoice"><a href="#">Despotism</a></li>        <li class="governmentChoice"><a href="#">Monarchy</a></li>        <li class="governmentChoice"><a href="#">Democracy</a></li>        <li class="governmentChoice"><a href="#">Fundamentalism</a></li>        <li class="governmentChoice"><a href="#">Fascism</a></li>        <li class="governmentChoice"><a href="#">Republic</a></li>        <li class="governmentChoice"><a href="#">Communism</a></li>       </ul>      </div>';}else{str+='<div class="dropdown govDropdown">       <button style="cursor: default" class="btn btn-primary dropdown-toggle shadow4 fwDropdownButton fwDropdownButtonEnemy" type="button">        <span id="lobbyGovernment'+i+'" class="pull-left">Despotism</span>        <i class="fa fa-caret-down text-disabled lobbyCaret"></i>       </button>      </div>';}
str+='</div></div>';}
str+='</div>';document.getElementById("lobbyPlayers").innerHTML=str;}
delete lobby.init;},join:function(d){console.info("Joining lobby...");var loadTime=Date.now()-g.startTime;if(loadTime<1000){d=0;}
if(d===undefined){d=.5;}
g.view="lobby";TweenMax.to("#titleMain",d,{autoAlpha:0,onComplete:function(){g.unlock(1);TweenMax.fromTo('#joinGameLobby',d,{autoAlpha:0},{autoAlpha:1});}});if(!d){loadGameState();}else{(function repeat(){if(g.view==="lobby"){$.ajax({type:"GET",url:"php/updateLobby.php"}).done(function(x){if(g.view==="lobby"){for(var i=1;i<=8;i++){var data=x.playerData[i];if(data!==undefined){if(data.account!==lobby.data[i].account){lobby.updatePlayer(data);}}else{if(lobby.data[i].account){lobby.chat(lobby.data[i].account+" has disconnected",'chat-warning')
var o={player:i}
lobby.updatePlayer(o);}}}
if(x.playerData[1]===undefined){lobby.hostLeft();}
setTimeout(repeat,5000);}}).fail(function(data){serverError(data);});}})();delete lobby.join;}},hostLeft:function(){Msg("The host has left the lobby.");setTimeout(function(){exitGame(true);},1000);},updatePlayer:function(data,i){var i=data.player;if(data.account!==undefined){console.info("ADD PLAYER: ",data);document.getElementById("lobbyRow"+i).style.display='block';document.getElementById("lobbyAccount"+i).innerHTML=data.account;document.getElementById("lobbyName"+i).innerHTML=data.nation;document.getElementById("lobbyFlag"+i).src='images/flags/'+data.flag;$('#lobbyFlag'+i).attr('title',data.flag.split(".").shift()).tooltip({container:'body'});lobby.updateGovernment(data);lobby.data[i]=data;}else{console.info("REMOVE PLAYER: ",data);document.getElementById("lobbyRow"+i).style.display='none';lobby.data[i]={account:''};}
lobby.styleStartGame();},styleStartGame:function(){if(my.player===1){var e=document.getElementById("startGame");if(lobby.totalPlayers()===1){e.className=lobby.startClassOff;}else{e.className=lobby.startClassOn;}}},updateGovernment:function(data){var i=data.player;document.getElementById('lobbyGovernment'+i).innerHTML=data.government;lobby.data[i].government=data.government;},countdown:function(data){socket.unsubscribe('title:refreshGames');if(!lobby.gameStarted){lobby.gameStarted=true;new Audio('sound/beepHi.mp3');var e=document.getElementById('countdown');e.style.display='block';(function repeating(secondsToStart){e.textContent="Starting game in "+secondsToStart--;if(secondsToStart>=0){audio.play('beep');setTimeout(repeating,1000,secondsToStart);}else{audio.play('beepHi');audio.load.game();video.load.game();}
if(secondsToStart===1){TweenMax.to('#mainWrap',1.5,{delay:1,alpha:0,ease:Linear.easeNone,onComplete:function(){loadGameState();}});audio.fade();}})(5);}},governmentIcon:function(government){var icon={Despotism:'fa fa-gavel',Monarchy:'glyphicon glyphicon-king',Democracy:'fa fa-institution',Fundamentalism:'fa fa-book',Fascism:'glyphicon glyphicon-fire',Republic:'glyphicon glyphicon-grain',Communism:'fa fa-flask'};return icon[government];}};function initOffensiveTooltips(){$('#fireCannons').attr('title','Fire cannons at an adjacent enemy tile. Kills '+(2+my.oBonus)+' + 4% of armies.').tooltip('fixTitle');$('#launchMissile').attr('title','Launch a missile at any enemy territory. Kills '+(5+(my.oBonus*2))+' + 15% of armies.').tooltip('fixTitle');$('#recruit').attr('title','Recruit '+(3+~~(my.cultureBonus / 30))+' armies. Boosted by culture.').tooltip('fixTitle');}
function initResources(d){my.food=d.food;my.production=d.production;my.culture=d.culture;DOM.production.textContent=d.production;DOM.food.textContent=d.food;DOM.culture.textContent=d.culture;DOM.manpower.textContent=my.manpower;my.manpower=d.manpower;DOM.foodMax.textContent=d.foodMax;DOM.cultureMax.textContent=d.cultureMax;DOM.sumFood.textContent=d.sumFood;DOM.sumProduction.textContent=d.turnProduction;DOM.sumCulture.textContent=d.sumCulture;DOM.oBonus.textContent=d.oBonus;DOM.dBonus.textContent=d.dBonus;DOM.turnBonus.textContent=d.turnBonus;DOM.foodBonus.textContent=d.foodBonus;DOM.cultureBonus.textContent=d.cultureBonus;setBars(d);}
function setProduction(d){TweenMax.to(my,.3,{production:d.production,ease:Quad.easeIn,onUpdate:function(){DOM.production.textContent=~~my.production;}});}
function setResources(d){setProduction(d);TweenMax.to(my,.3,{food:d.food,culture:d.culture,ease:Quad.easeIn,onUpdate:function(){DOM.food.textContent=~~my.food;DOM.culture.textContent=~~my.culture;}});if(d.manpower>my.manpower){TweenMax.fromTo('#manpower',.5,{color:'#ffaa33'},{color:'#ffff00',repeat:-1,yoyo:true});TweenMax.to(my,.5,{manpower:d.manpower,onUpdate:function(){DOM.manpower.textContent=~~my.manpower;}});}
if(d.foodMax!==undefined){if(d.foodMax>my.foodMax){DOM.foodMax.textContent=d.foodMax;my.foodMax=d.foodMax;}
if(d.cultureMax>my.cultureMax){DOM.cultureMax.textContent=d.cultureMax;my.cultureMax=d.cultureMax;}}
if(d.sumFood!==undefined){if(d.sumFood!==my.sumFood){DOM.sumFood.textContent=d.sumFood;my.sumFood=d.sumFood;}
if(d.sumProduction!==my.sumProduction){DOM.sumProduction.textContent=d.sumProduction;my.sumProduction=d.sumProduction;}
if(d.sumCulture!==my.sumCulture){DOM.sumCulture.textContent=d.sumCulture;my.sumCulture=d.sumCulture;}}
if(d.oBonus!==undefined){if(my.oBonus!==d.oBonus){DOM.oBonus.textContent=d.oBonus;my.oBonus=d.oBonus;initOffensiveTooltips();}
if(my.dBonus!==d.dBonus){DOM.dBonus.textContent=d.dBonus;my.dBonus=d.dBonus;}
if(my.turnBonus!==d.turnBonus){DOM.turnBonus.textContent=d.turnBonus;my.turnBonus=d.turnBonus;}
if(my.foodBonus!==d.foodBonus){DOM.foodBonus.textContent=d.foodBonus;my.foodBonus=d.foodBonus;}
if(my.cultureBonus!==d.cultureBonus){DOM.cultureBonus.textContent=d.cultureBonus;my.cultureBonus=d.cultureBonus;initOffensiveTooltips();}}
setBars(d);}
function setBars(d){TweenMax.to(DOM.foodBar,.3,{width:((d.food / d.foodMax)*100)+'%'});TweenMax.to(DOM.cultureBar,.3,{width:((d.culture / d.cultureMax)*100)+'%'});}
function Nation(){this.account="";this.nation="";this.flag="";this.alive=true;return this;}
function loadGameState(){g.lock(1);var e1=document.getElementById("mainWrap");if(e1!==null){TweenMax.to(e1,.5,{alpha:0});}
console.warn("Loading: "+g.map.key+".php");$.ajax({type:'GET',url:'maps/'+g.map.key+'.php'}).done(function(data){document.getElementById('worldWrap').innerHTML=data;var loadGameDelay=location.host==='localhost'?0:1000;setTimeout(function(){$.ajax({type:"GET",url:"php/loadGameState.php"}).done(function(data){g.map.sizeX=data.mapData.sizeX;g.map.sizeY=data.mapData.sizeY;g.map.name=data.mapData.name;g.map.tiles=data.mapData.tiles;if(data.tiles.length<g.map.tiles){if(g.loadAttempts<10){setTimeout(function(){g.loadAttempts++;loadGameState();},1000);}else{Msg("Failed to load game data");setTimeout(function(){window.onbeforeunload=null;location.reload();},3000);}
return;}
initDom();g.screen.resizeMap();audio.gameMusicInit();console.info('loadGameState ',data);audio.load.game();video.load.game();my.player=data.player;my.account=data.account;my.oBonus=data.oBonus;my.dBonus=data.dBonus;my.cultureBonus=data.cultureBonus;my.tech=data.tech;my.capital=data.capital;my.flag=data.flag;my.nation=data.nation;my.foodMax=data.foodMax;my.production=data.production;my.turnProduction=data.turnProduction;my.cultureMax=data.cultureMax;my.government=data.government;my.buildCost=data.buildCost;lobby.updateGovernmentWindow(my.government);if(my.government==='Despotism'){document.getElementById('splitAttackCost').textContent=0;my.splitAttackCost=0;}else if(my.government==='Monarchy'){my.buildCost=.5;}else if(my.government==='Democracy'){my.maxDeployment=254;}else if(my.government==='Fundamentalism'){document.getElementById('recruitCost').textContent=15;my.recruitCost=15;}else if(my.government==='Fascism'){document.getElementById('attackCost').textContent=8;my.attackCost=8;document.getElementById('deployCost').textContent=5;my.deployCost=5;}else if(my.government==='Communism'){DOM.gunpowderCost.textContent=40;DOM.engineeringCost.textContent=60;DOM.rocketryCost.textContent=100;DOM.atomicTheoryCost.textContent=125;DOM.futureTechCost.textContent=500;DOM.cannonsCost.textContent=20;DOM.missileCost.textContent=30;DOM.nukeCost.textContent=200;my.weaponCost=.5;}
game.initialized=true;for(var z=0,len=game.player.length;z<len;z++){game.player[z]=new Nation();}
g.removeContainers();g.unlock();g.view="game";var e=document.getElementById("gameWrap");TweenMax.fromTo(e,1,{autoAlpha:0},{autoAlpha:1});var mapCapitals=document.getElementById('mapCapitals'),mapUpgrades=document.getElementById('mapUpgrades'),mapBars=document.getElementById('mapBars');for(var i=0,len=data.tiles.length;i<len;i++){var d=data.tiles[i];game.tiles[i]={name:d.tileName,account:d.account,player:d.player,nation:d.nation,flag:d.flag,capital:data.capitalTiles.indexOf(i)>-1&&d.flag?true:false,units:d.units,food:d.food,culture:d.culture,defense:d.defense}
var zig=document.getElementById('unit'+i);if(zig!==null){zig.textContent=d.units===0?0:d.units;if(d.units){zig.style.visibility='visible';}}
if(d.player){TweenMax.set(document.getElementById('land'+i),{fill:color[d.player]});}}
for(var i=0,len=data.players.length;i<len;i++){var d=data.players[i];game.player[d.player].account=d.account;game.player[d.player].flag=d.flag;game.player[d.player].nation=d.nation;game.player[d.player].player=d.player;game.player[d.player].government=d.government;}
var a=document.getElementsByClassName('unit'),mapBars=document.getElementById('mapBars'),mapFlagWrap=document.getElementById('mapFlagWrap');for(var i=0,len=a.length;i<len;i++){var t=game.tiles[i];var x=a[i].getAttribute('x')-24;var y=a[i].getAttribute('y')-24;var flag='blank.png';if(t!==undefined){if(!t.flag&&t.units){flag="Player0.jpg";}else if(t.flag){flag=t.flag;}}
var svg=document.createElementNS('http://www.w3.org/2000/svg','image');svg.id='flag'+i;svg.setAttributeNS(null,'height',24);svg.setAttributeNS(null,'width',24);svg.setAttributeNS(null,"x",x);svg.setAttributeNS(null,"y",y+5);svg.setAttributeNS(null,"class","mapFlag");svg.setAttributeNS('http://www.w3.org/1999/xlink','xlink:href','images/flags/'+flag);mapFlagWrap.appendChild(svg);if(game.tiles[i].capital){var svg=document.createElementNS('http://www.w3.org/2000/svg','image');svg.setAttributeNS(null,'height',30);svg.setAttributeNS(null,'width',30);svg.setAttributeNS(null,"x",x-15);svg.setAttributeNS(null,"y",y+17);svg.setAttributeNS('http://www.w3.org/1999/xlink','xlink:href','images/capital.png');mapCapitals.appendChild(svg);TweenMax.to(svg,60,{transformOrigin:'50% 50%',rotation:360,repeat:-1,ease:Linear.easeNone});}
animate.initMapBars(i);}
var str='<div id="diploHead">    <span id="options" class="pointer options">Options</span> |    <span id="surrender" class="pointer">Surrender</span>   </div><hr class="fancyhr">';for(var i=0,len=game.player.length;i<len;i++){var p=game.player[i],_flagArr=p.flag.split("."),_flag=_flagArr[0];if(p.flag){var flag
if(p.flag==='Default.jpg'){str+='<div id="diplomacyPlayer'+p.player+'" class="diplomacyPlayers alive">';str+='<i class="'+lobby.governmentIcon(p.government)+' diploSquare" data-placement="right" data-toggle="tooltip" title="'+p.government+'"></i>'+'<img src="images/flags/Player'+p.player+'.jpg" class="player'+p.player+' inlineFlag diploFlag p'+p.player+'b" data-toggle="tooltip" data-container="#diplomacy-ui" data-placement="right" title="'+_flag+'">'+'<span class="diploNames large" data-toggle="tooltip" data-placement="right" title="'+p.account+'">'+p.nation+'</span>';}else{str+='<div id="diplomacyPlayer'+p.player+'" class="diplomacyPlayers alive">';str+='<i class="'+lobby.governmentIcon(p.government)+' diploSquare" data-placement="right" data-toggle="tooltip" title="'+p.government+'"></i>'+'<img src="images/flags/'+p.flag+'" class="inlineFlag diploFlag p'+p.player+'b" data-toggle="tooltip" data-container="#diplomacy-ui" data-placement="right" title="'+_flag+'">'+'<span class="diploNames large" data-toggle="tooltip" data-placement="right" title="'+p.account+'">'+p.nation+'</span>';}
str+='</div>';}}
document.getElementById('diplomacy-ui').innerHTML=str;$('[data-toggle="tooltip"]').tooltip({delay:{show:0,hide:0}});initResources(data);setTimeout(function(){worldMap=Draggable.create(DOM.worldWrap,{type:'x,y',bounds:"#gameWrap"});initOffensiveTooltips();TweenMax.set(DOM.targetLine,{stroke:color[my.player]});TweenMax.set(DOM.targetLine,{stroke:"hsl(+=0%, +=80%, +=25%)"});function triggerAction(that){if(my.attackOn){var o=my.targetData;if(o.attackName==='attack'){action.attack(that);}else if(o.attackName==='cannons'){action.fireCannons(that);}else if(o.attackName==='missile'){action.launchMissile(that);}else if(o.attackName==='nuke'){action.launchNuke(that);}}else{showTarget(that);}}
var zug=$('.land');if(isMSIE||isMSIE11){zug.on("click",function(){triggerAction(this);});}else{zug.on("mousedown",function(e){var box=this.getBBox();var x=Math.round(box.x+(box.width/2));var y=Math.round(box.y+(box.height/2));triggerAction(this);});}
zug.on("mouseenter",function(){my.lastTarget=this;if(my.attackOn){showTarget(this,true);}
TweenMax.set(this,{fill:"hsl(+=0%, +=30%, +=15%)"});}).on("mouseleave",function(){var land=this.id.slice(4)*1;if(game.tiles.length>0){var player=game.tiles[land]!==undefined?game.tiles[land].player:0;TweenMax.to(this,.25,{fill:color[player]});}});my.focusTile(my.capital);if(location.host!=='localhost'){window.onbeforeunload=function(){return"To leave the game use the surrender flag instead!";}}
game.startGameState();},100);animate.water();}).fail(function(data){serverError(data);}).always(function(){g.unlock();});},loadGameDelay);});}
function startGame(){if(lobby.totalPlayers()>=2&&my.player===1){document.getElementById("startGame").style.display="none";g.lock(1);audio.play('click');$.ajax({type:"GET",url:"php/startGame.php"}).done(function(data){console.info('startGame: ',data);g.unlock();}).fail(function(data){serverError(data);}).always(function(){g.unlock();});}}
var socket={removePlayer:function(account){var o={type:'remove',account:my.account}
socket.zmq.publish('title:'+my.channel,o);delete title.players[account];},addPlayer:function(account,flag){var o={type:'add',account:my.account,flag:my.flag}
socket.zmq.publish('title:'+my.channel,o);title.players[account]={flag:flag}},unsubscribe:function(channel){try{socket.zmq.unsubscribe(channel);}catch(err){console.warn(err);}},setChannel:function(channel){if(g.view==='title'){$.ajax({type:"POST",url:"php/titleChangeChannel.php",data:{channel:channel}}).done(function(data){console.info("NEW CHANNEL: "+data);socket.removePlayer(my.account);socket.unsubscribe('title:'+my.channel);my.channel=data.channel;for(var key in title.players){delete title.players[key];}
title.chat("You have joined channel: "+data.channel+".","chat-warning");socket.zmq.subscribe('title:'+data.channel,function(topic,data){title.chatReceive(data);});socket.addPlayer(my.account,my.flag);document.getElementById('titleChatHeaderChannel').textContent=data.channel;document.getElementById('titleChatBody').innerHTML='';title.updatePlayers();});}},enableWhisper:function(){var channel='account:'+my.account;socket.zmq.subscribe(channel,function(topic,data){if(data.message){if(data.action==='send'){var msg=data.flag+data.account+' whispers: '+data.message;title.receiveWhisper(msg,'chat-whisper');$.ajax({url:'php/insertWhisper.php',data:{action:"",account:data.account,message:data.message}});}else{var msg=data.flag+'To '+data.account+': '+data.message;title.receiveWhisper(msg,'chat-whisper');}}});(function keepAliveWs(){setTimeout(function(){console.clear();},10000);socket.zmq.publish(channel,{type:"keepAlive"});setTimeout(keepAliveWs,180000);})();},joinGame:function(){(function repeat(){if(socket.enabled){socket.unsubscribe('title:'+my.channel);socket.zmq.subscribe('game:'+game.id,function(topic,data){title.chatReceive(data);});}else{setTimeout(repeat,100);}})();},enabled:false,connectionTries:0,connectionRetryDuration:250,init:function(){var e=document.getElementById('titleMenu');if(e!==null){socket.zmq=new ab.Session('wss://'+location.hostname+'/wss2/',function(){socket.connectionSuccess();},function(){socket.connectionFailure();},{'skipSubprotocolCheck':true});}},connectionSuccess:function(){socket.enabled=true;console.info("Socket connection established with server");title.chat("You have joined channel: "+my.channel+".","chat-warning");socket.zmq.subscribe('title:'+my.channel,function(topic,data){title.chatReceive(data);});socket.zmq.subscribe('title:refreshGames',function(topic,data){title.updateGame(data);});socket.zmq.subscribe('admin:broadcast',function(topic,data){g.chat(data.msg,data.type);});(function repeat(){if(my.account){socket.enableWhisper();}else{setTimeout(repeat,200);}})();},connectionFailure:function(){console.warn('WebSocket connection failed. Retrying...');socket.enabled=false;if(++socket.connectionTries*socket.connectionRetryDuration<60000){setTimeout(socket.init,socket.connectionRetryDuration);}}}
socket.init();var audio={ext:(function(a){return!!(a.canPlayType&&a.canPlayType('audio/mpeg;').replace(/no/,''))?'mp3':'ogg'})(document.createElement('audio')),on:(function(a){return!!a.canPlayType?true:false;})(document.createElement('audio')),play:function(foo,bg){if(foo&&audio.ext==='mp3'&&g.config.audio.soundVolume){if(bg){DOM.bgmusic.pause();DOM.bgmusic.src="music/"+foo+"."+audio.ext;DOM.bgmusic.play();}else{var sfx=new Audio("sound/"+foo+"."+audio.ext);sfx.volume=g.config.audio.soundVolume / 100;sfx.play();}}},save:function(){var foo=JSON.stringify(g.config);localStorage.setItem('config',foo);},setMusicVolume:function(val){if(g.config.audio.musicVolume){if(!val){audio.pause();}}else{audio.musicStart();}
DOM.bgmusic.volume=val / 100;g.config.audio.musicVolume=val;audio.save();},setSoundVolume:function(val){g.config.audio.soundVolume=val;audio.save();},pause:function(){DOM.bgmusic.pause();},trackIndex:0,totalTracks:1,gameMusicInit:function(){if(audio.ext==='mp3'&&g.config.audio.musicVolume){audio.pause();audio.trackIndex=~~(Math.random()*audio.totalTracks);audio.gameMusicPlayNext();}},gameMusicPlayNext:function(){if(audio.ext==='mp3'){var tracks=['WaitingBetweenWorlds']
audio.trackIndex++;if(my.government){}
DOM.bgmusic.src="music/"+tracks[audio.trackIndex%audio.totalTracks]+"."+audio.ext;DOM.bgmusic.volume=g.config.audio.musicVolume / 100;DOM.bgmusic.onended=function(){audio.gameMusicPlayNext();}
if(g.config.audio.musicVolume){DOM.bgmusic.play();}else{DOM.bgmusic.pause();}}},fade:function(){var x={vol:1}
TweenMax.to(x,2.5,{vol:0,ease:Linear.easeNone,onUpdate:function(){DOM.bgmusic.volume=x.vol;}});},move:function(){audio.play('boots'+~~(Math.random()*3));},cache:{},load:{title:function(){if(audio.ext==='mp3'){var x=['click','beep'];for(var i=0,len=x.length;i<len;i++){var z=x[i];audio.cache[z]=new Audio("sound/"+z+".mp3");}}},game:function(){if(audio.ext==='mp3'){var x=['machine0','machine1','machine2','machine3','machine4','machine5','machine6','machine7','machine8','machine9','boots0','boots1','boots2','chat','food','culture','error','build','grenade5','grenade6','grenade8','missile7','bomb9','warning','research'];for(var i=0,len=x.length;i<len;i++){var z=x[i];audio.cache[z]=new Audio("sound/"+z+".mp3");}}}},musicStart:function(){if(g.view!=='game'){audio.play("ReturnOfTheFallen",1);}else{audio.gameMusicPlayNext();}}}
audio.init=(function(){console.info("Checking local data...");var config=localStorage.getItem('config');if(config===null){audio.save();}else{var foo=JSON.parse(config);if(g.config.audio.musicOn===undefined){g.config.audio=foo.audio;}}
audio.load.title();if(!g.config.audio.musicVolume){audio.pause();}else{audio.musicStart();}
g.checkPlayerData();var initComplete=false;$("#musicSlider").slider({min:0,max:100,value:g.config.audio.musicVolume,formatter:function(value){if(initComplete){audio.setMusicVolume(value);return value;}else{return g.config.audio.musicVolume;}}}).slider('setValue',g.config.audio.musicVolume);$("#soundSlider").slider({min:0,max:100,value:g.config.audio.soundVolume,tooltip_position:'bottom',formatter:function(value){if(initComplete){audio.setSoundVolume(value);return value;}else{return g.config.audio.soundVolume}}}).on('slideStop',function(val){audio.play('machine0');}).slider('setValue',g.config.audio.soundVolume);initComplete=true;})();function mouseZoomIn(e){if(g.mouse.zoom>=200){g.mouse.zoom=200;}else{g.mouse.zoom+=5;TweenMax.to("#worldWrap",.5,{transformOrigin:g.mouse.transX+"% "+g.mouse.transY+"%",force3D:false,smoothOrigin:true,scale:g.mouse.zoom / 100,onUpdate:function(){worldMap[0].applyBounds();},onComplete:function(){worldMap[0].applyBounds();}});}}
function mouseZoomOut(e){if(g.mouse.zoom<=100){g.mouse.zoom=100;}else{g.mouse.zoom-=5;TweenMax.to("#worldWrap",.5,{force3D:false,smoothOrigin:true,transformOrigin:g.mouse.transX+"% "+g.mouse.transY+"%",scale:g.mouse.zoom / 100,onUpdate:function(){worldMap[0].applyBounds();},onComplete:function(){worldMap[0].applyBounds();}});}
worldMap[0].applyBounds();}
function setMousePosition(X,Y){var x=~~((X / g.map.sizeX)*100);var y=~~((Y / g.map.sizeY)*100);g.mouse.transX=x;g.mouse.transY=y;}
function updateTileInfo(tileId){var t=game.tiles[tileId],flag="Default.jpg",name=t.name,account="",name=t.name;if(t.player===0){flag="Player0.jpg";if(t.units>0){name="Barbarian Tribe";}else{name="Uninhabited";flag="Default.jpg";}}else{if(t.flag==="Default.jpg"){flag="Player"+t.player+".jpg";}else{flag=t.flag;}
name=t.name;account=t.account;}
var str=''
DOM.targetFlag.innerHTML='<img src="images/flags/'+flag+'" class="p'+t.player+'b w100 block center">';var str='';if(t.capital){str+='<span id="tileName" class="no-select fa-stack" data-toggle="tooltip" title="Capital Palace<br> Boosts tile defense">   <i class="glyphicon glyphicon-star capitalStar"></i>  </span> ';}
if(!t.player){var foodWidth=0;var cultureWidth=0;var defWidth=0;}else{var foodWidth=((t.food>8?8:t.food)/ 8)*100;var cultureWidth=((t.culture>8?8:t.culture)/ 8)*100;var defWidth=(t.defense / 4)*100;}
str+=name+'</div>  <div class="targetBarsWrap">   <hr class="targetBarsFood" style="width: '+foodWidth+'%"/>   <hr class="targetBarsFood" style="width: '+foodWidth+'%"/>  </div>  <div class="targetBarsWrap"">   <hr class="targetBarsCulture" style="width: '+cultureWidth+'%"/>   <hr class="targetBarsCulture" style="width: '+cultureWidth+'%"/>  </div>  <div class="targetBarsWrap"">   <hr class="targetBarsDefense" style="width: '+defWidth+'%"/>   <hr class="targetBarsDefense" style="width: '+defWidth+'%"/>  </div>';DOM.targetName.innerHTML=str;var defWord=['Bunker','Wall','Fortress'],ind=t.defense-(t.capital?1:0);var defTooltip=['',' Walls reduce cannon damage by 50% and cannot be flipped by Revolutionaries.',' Fortresses reduce cannon damage by 75%, missile damage by 50%, and cannot be flipped by Revolutionaries.'];if(ind>2){DOM.upgradeTileDefense.style.display='none';}else{DOM.upgradeTileDefense.style.display='block';DOM.buildWord.textContent=defWord[ind];DOM.buildCost.textContent=g.upgradeCost[ind]*my.buildCost;if(ind===2){defWord[2]='Fortresse';}
var tooltip=defWord[ind]+'s upgrade the defense of a territory.'+defTooltip[ind];$('#upgradeTileDefense').attr('title',tooltip).tooltip('fixTitle').tooltip('hide');}
my.player===t.player?DOM.tileActions.style.display='block':DOM.tileActions.style.display='none';action.setMenu();}
function showTarget(e,hover,skipOldTgtUpdate){if(e.id===undefined){e.id='land0';}
if(typeof e==='object'){var tileId=e.id.slice(4)*1;var d=game.tiles[tileId];var cacheOldTgt=my.tgt;if(!hover){if(cacheOldTgt!==tileId){my.tgt=tileId;animate.glowTile(cacheOldTgt,tileId);}}
if(hover&&tileId!==my.tgt){var e=document.getElementById('unit'+tileId);my.targetLine[4]=e.getAttribute('x')*1-10;my.targetLine[5]=e.getAttribute('y')*1-10;my.targetLine[2]=(my.targetLine[0]+my.targetLine[4])/ 2;my.targetLine[3]=((my.targetLine[1]+my.targetLine[5])/ 2)-100;TweenMax.set(DOM.targetLineShadow,{visibility:'visible',attr:{d:"M "+my.targetLine[0]+","+my.targetLine[1]+" "
+my.targetLine[4]+","+my.targetLine[5]}});TweenMax.set(DOM.targetLine,{visibility:'visible',attr:{d:"M "+my.targetLine[0]+","+my.targetLine[1]+" Q "+my.targetLine[2]+" "+my.targetLine[3]+" "
+my.targetLine[4]+" "+my.targetLine[5]}});TweenMax.fromTo([DOM.targetLine,DOM.targetLineShadow],.2,{strokeDashoffset:0},{strokeDashoffset:-12,repeat:-1,ease:Linear.easeNone});TweenMax.set(DOM.targetCrosshair,{fill:'#00dd00',visibility:'visible',x:my.targetLine[4]-255,y:my.targetLine[5]-257,transformOrigin:'50% 50%'})
TweenMax.fromTo(DOM.targetCrosshair,.2,{scale:.1},{repeat:-1,yoyo:true,scale:.08});}
if(!skipOldTgtUpdate){my.lastTgt=cacheOldTgt;}
updateTileInfo(tileId);my.flashTile(tileId);}else{my.attackOn=false;my.attackName='';}}
function setTileUnits(i,unitColor){var e=document.getElementById('unit'+i);e.textContent=game.tiles[i].units===0?"":~~game.tiles[i].units;if(unitColor==='#00ff00'){TweenMax.to(e,.05,{startAt:{transformOrigin:(game.tiles[i].units.length*3)+' 12',fill:unitColor},fill:'#ffffff',ease:SteppedEase.config(1),repeat:12,yoyo:true});}else{TweenMax.to(e,.5,{startAt:{fill:'#ff0000'},ease:Power2.easeIn,fill:'#ffffff'});}}
function gameDefeat(){new Audio('sound/shotgun2.mp3');$.ajax({type:"GET",url:"php/gameDefeat.php"}).done(function(data){if(data.gameDone){var msg='<p>Defeat!</p>'+'<div>Your campaign for world domination has failed!</div>'+'<div id="endWar" class="endBtn">'+'<div class="modalBtnChild">Concede Defeat</div>'+'</div>';if(!g.done){msg+='<div id="spectate" class="endBtn">'+'<div class="modalBtnChild">Spectate</div>'+'</div>';}
triggerEndGame(msg);audio.play('shotgun2');}}).fail(function(data){serverError(data);});g.keepAlive();}
function gameVictory(){new Audio('sound/shotgun2.mp3');new Audio('sound/mine4.mp3');$.ajax({type:"GET",url:"php/gameVictory.php"}).done(function(data){if(data.ceaseFire){var msg='<p>Armistice!</p>'+'<div>The campaign has been suspended!</div>'+'<div id="endWar" class="endBtn">'+'<div class="modalBtnChild">Cease Fire</div>'+'</div>';audio.play('shotgun2');}else if(data.gameDone){var msg='<p>Congratulations!</p>'+'<div>Your campaign for global domination has succeeded!</div>'+'<div id="endWar" class="endBtn">'+'<div class="modalBtnChild">Victory</div>'+'</div>';audio.play('mine4');}
triggerEndGame(msg);}).fail(function(data){serverError(data);});g.keepAlive();}
function triggerEndGame(msg){$("*").off('click mousedown keydown keyup keypress');$("#chat-input").remove();window.onbeforeunload=null;setTimeout(function(){g.over=1;},1500);setTimeout(function(){var e=document.getElementById('victoryScreen');e.innerHTML=msg;e.style.display='block';$("#endWar").on('mousedown',function(e){if(e.which===1){location.reload();}});$("#spectate").on('mousedown',function(e){if(e.which===1){$("#victoryScreen, #ui2, #resources-ui").remove();}});},2500);}
function Target(o){if(o===undefined){o={};}
this.cost=o.cost?o.cost:10;this.minimum=o.minimum!==undefined?o.minimum:2;this.attackName=o.attackName?o.attackName:'attack';this.splitAttack=o.splitAttack?o.splitAttack:false;this.hudMsg=o.hudMsg?o.hudMsg:'Select Target';}
var action={error:function(msg){if(msg===undefined){msg="Not enough energy!";}
Msg(msg,1.5);my.clearHud();showTarget(document.getElementById('land'+my.tgt));},target:function(o){my.targetData=o;console.info(my.attackOn,my.tgt,game.tiles[my.tgt].player,my.player);if(game.tiles[my.tgt].player!==my.player){return;}
if(my.attackOn&&o.attackName===my.attackName){my.attackOn=false;my.attackName='';my.clearHud();showTarget(document.getElementById('land'+my.tgt));return;}
if(my.production<o.cost){action.error();return;}
if(game.tiles[my.tgt].units<o.minimum){Msg("You need at least "+o.minimum+" armies to attack!",1.5);my.clearHud();return;}
if(my.player===game.tiles[my.tgt].player){my.attackOn=true;my.attackName=o.attackName;my.splitAttack=o.splitAttack;my.hud(o.hudMsg);$DOM.head.append('<style>.land{ cursor: crosshair; }</style>');var e=document.getElementById('unit'+my.tgt);my.targetLine[0]=e.getAttribute('x')*1-10;my.targetLine[1]=e.getAttribute('y')*1-10;showTarget(my.lastTarget,true);}},attack:function(that){var attacker=my.tgt;var defender=that.id.slice(4)*1;if(my.tgt===defender){return;}
if(game.tiles[defender].player===my.player){if(game.tiles[defender].units>=255){Msg("That territory has the maximum number of units!",1.5);my.clearHud();return;}}
my.attackOn=false;my.attackName='';if(game.tiles[my.tgt].units===1){Msg("You need at least 2 armies to move/attack!",1.5);my.clearHud();return;}
if((my.production<my.attackCost&&!my.splitAttack)||(my.production<my.splitAttackCost&&my.splitAttack)){action.error();return;}
g.lock(true);showTarget(that);my.clearHud();$.ajax({url:'php/attackTile.php',data:{attacker:attacker,defender:defender,split:my.splitAttack?1:0}}).done(function(data){console.info('attackTile',data);if(game.tiles[defender].player!==my.player){if(!game.tiles[defender].units){audio.move();}}else{audio.move();}
if(data.rewardMsg!==undefined){game.chat(data.rewardMsg);}
if(data.production!==undefined){setProduction(data);}
console.warn(data.victory,attacker,my.tgt);if(!data.victory){showTarget(document.getElementById('land'+attacker));}}).fail(function(e){audio.play('error');Msg('You can only attack adjacent territories.',1.5);showTarget(document.getElementById('land'+attacker));}).always(function(){g.unlock();});},deploy:function(){var t=game.tiles[my.tgt];if(t.player!==my.player){return;}
if(my.production<my.deployCost){action.error();return;}
if(!my.manpower){action.error("No armies available for deployment!");return;}
if(t.units<=254){var deployedUnits=my.manpower<my.maxDeployment?my.manpower:my.maxDeployment,tgt=my.tgt;var rem=0;if(t.units+deployedUnits>255){rem=~~((t.units+deployedUnits)-255);deployedUnits=~~(255-t.units);}else{rem=my.manpower-deployedUnits;}
console.log('deploy: ',tgt,t.units,deployedUnits);$.ajax({url:'php/deploy.php',data:{deployedUnits:deployedUnits,target:tgt}}).done(function(data){console.info("deploy: ",data);if(data.production!==undefined){audio.move();my.manpower=data.manpower;DOM.manpower.textContent=my.manpower;setProduction(data);setTileUnits(tgt,'#00ff00');}}).fail(function(e){audio.play('error');});TweenMax.set('#manpower',{color:'#fff'});}},recruit:function(){var t=game.tiles[my.tgt];if(t.player!==my.player){return;}
if(my.production<my.recruitCost){action.error();return;}
if(t.units<=254){$.ajax({url:'php/recruit.php',data:{target:my.tgt}}).done(function(data){console.info("recruit: ",data.production,data);if(data.production!==undefined){setProduction(data);}
var deployedUnits=3+~~(my.cultureBonus / 30);if(t.units+deployedUnits>255){game.tiles[my.tgt].units=255;}else{game.tiles[my.tgt].units+=deployedUnits;}
setTileUnits(my.tgt,'#00ff00');audio.move();}).fail(function(e){audio.play('error');});}},upgradeTileDefense:function(){var oldTgt=my.tgt;var t=game.tiles[my.tgt],ind=t.defense-t.capital?1:0;if(t.player!==my.player){return;}
if(ind>2){return;}
if(my.production<(g.upgradeCost[ind]*my.buildCost)){action.error();return;}
$.ajax({url:'php/upgradeTileDefense.php',data:{target:my.tgt}}).done(function(data){console.info("upgradeTileDefense: ",data);if(data.production!==undefined){setProduction(data);}
if(oldTgt===my.tgt){game.tiles[my.tgt].defense++;showTarget(document.getElementById('land'+my.tgt));}}).fail(function(e){console.info(e.responseText);Msg(e.statusText);audio.play('error');});},fireCannons:function(that){var attacker=my.tgt;var defender=that.id.slice(4)*1;if(my.tgt===defender){return;}
if(game.tiles[defender].player===my.player){return;}
if(game.tiles[my.tgt].units===0){return;}
my.attackOn=false;my.attackName='';if(my.production<40*my.weaponCost){action.error();return;}
g.lock(true);my.clearHud();showTarget(document.getElementById('land'+attacker));$.ajax({url:'php/fireCannons.php',data:{attacker:attacker,defender:defender}}).done(function(data){console.info('fireCannons',data);animate.cannons(defender,true);if(data.production!==undefined){setProduction(data);}}).fail(function(e){console.info('error: ',e);audio.play('error');if(e.statusText){Msg(e.statusText,1.5);}}).always(function(){g.unlock();});},launchMissile:function(that){var attacker=my.tgt;var defender=that.id.slice(4)*1;if(my.tgt===defender){return;}
if(game.tiles[defender].player===my.player){return;}
if(game.tiles[my.tgt].units===0){return;}
my.attackOn=false;my.attackName='';if(my.production<60*my.weaponCost){action.error();return;}
g.lock(true);my.clearHud();showTarget(document.getElementById('land'+attacker));$.ajax({url:'php/launchMissile.php',data:{attacker:attacker,defender:defender}}).done(function(data){console.info('launchMissile',data);if(data.production!==undefined){setProduction(data);}
setTimeout(function(){$.ajax({url:'php/launchMissileHit.php',data:{attacker:attacker,defender:defender}}).fail(function(e){console.info('error: ',e);if(e.statusText){Msg(e.statusText,1.5);}});},2000);}).fail(function(e){console.info('error: ',e);audio.play('error');if(e.statusText){Msg(e.statusText,1.5);}}).always(function(){g.unlock();});},launchNuke:function(that){var attacker=my.tgt;var defender=that.id.slice(4)*1;if(my.tgt===defender){return;}
if(game.tiles[defender].player===my.player){return;}
if(game.tiles[my.tgt].units===0){return;}
my.attackOn=false;my.attackName='';if(my.production<400*my.weaponCost){action.error();return;}
g.lock(true);my.clearHud();showTarget(document.getElementById('land'+attacker));$.ajax({url:'php/launchNuke.php',data:{attacker:attacker,defender:defender}}).done(function(data){var e1=document.getElementById('land'+defender),box=e1.getBBox();setTimeout(function(){$.ajax({url:'php/launchNukeHit.php',data:{defender:defender}}).done(function(data){});},6000);console.info('launchNuke',data);if(data.production!==undefined){setProduction(data);}}).fail(function(e){console.info('error: ',e);audio.play('error');if(e.statusText){Msg(e.statusText,1.5);}}).always(function(){g.unlock();});},setMenu:function(){DOM.researchEngineering.style.display=my.tech.engineering?'none':'block';DOM.researchGunpowder.style.display=my.tech.gunpowder?'none':'block';DOM.researchRocketry.style.display=my.tech.rocketry||!my.tech.gunpowder?'none':'block';DOM.researchAtomicTheory.style.display=my.tech.atomicTheory||!my.tech.gunpowder||!my.tech.rocketry||!my.tech.engineering?'none':'block';var display='block';if(!my.tech.engineering||!my.tech.gunpowder||!my.tech.rocketry||!my.tech.atomicTheory){display='none';}
DOM.researchFutureTech.style.display=display;if(!game.tiles[my.tgt].defense){DOM.upgradeTileDefense.style.display='block';}else{var capValue=game.tiles[my.tgt].capital?1:0,dMinusPalace=game.tiles[my.tgt].defense-capValue,display='none';if(!my.tech.engineering){if(!dMinusPalace){display='block';}}else{if(dMinusPalace<3){display='block';}}
DOM.upgradeTileDefense.style.display=display;}
DOM.fireCannons.style.display=my.tech.gunpowder?'block':'none';DOM.launchMissile.style.display=my.tech.rocketry?'block':'none';DOM.launchNuke.style.display=my.tech.atomicTheory?'block':'none';}}
function toggleChatMode(bypass){g.chatOn=g.chatOn?false:true;if(g.chatOn){$DOM.chatInput.focus();DOM.chatInput.className='fw-text noselect nobg chatOn';}else{var msg=$DOM.chatInput.val().trim();if(bypass&&msg){if(msg.indexOf('/whisper ')===0){title.sendWhisper(msg,'/whisper ');}else if(msg.indexOf('/w ')===0){title.sendWhisper(msg,'/w ');}else{$.ajax({url:'php/insertChat.php',data:{message:msg}});}}
$DOM.chatInput.val('').blur();DOM.chatInput.className='fw-text noselect nobg';}}
$("#gameWrap").on("mousedown",'#attack',function(e){if(e.which===1){var o=new Target({});action.target(o);}}).on('mousedown','#deploy',function(e){if(e.which===1){action.deploy();}}).on('mousedown','#splitAttack',function(e){if(e.which===1){var o=new Target({cost:3,splitAttack:true});action.target(o);}}).on('mousedown','#recruit',function(e){if(e.which===1){action.recruit();}}).on('mousedown','#upgradeTileDefense',function(e){if(e.which===1){action.upgradeTileDefense();}}).on('mousedown','#researchGunpowder',function(e){if(e.which===1){research.gunpowder();}}).on('mousedown','#researchEngineering',function(e){if(e.which===1){research.engineering();}}).on('mousedown','#researchRocketry',function(e){if(e.which===1){research.rocketry();}}).on('mousedown','#researchAtomicTheory',function(e){if(e.which===1){research.atomicTheory();}}).on('mousedown','#researchFutureTech',function(e){if(e.which===1){research.futureTech();}}).on('mousedown','#fireCannons',function(e){if(e.which===1){var o=new Target({cost:60,minimum:0,attackName:'cannons',hudMsg:'Fire Cannons'});action.target(o);}}).on('mousedown','#launchMissile',function(e){if(e.which===1){var o=new Target({cost:120,minimum:0,attackName:'missile',hudMsg:'Launch Missile'});action.target(o);}}).on('mousedown','#launchNuke',function(e){if(e.which===1){var o=new Target({cost:600,minimum:0,attackName:'nuke',hudMsg:'Launch Nuclear Weapon'});action.target(o);}});var research={gunpowder:function(){$.ajax({type:'GET',url:'php/researchGunpowder.php'}).done(function(data){my.tech.gunpowder=1;research.report(data,"Gunpowder");}).fail(function(data){console.info('gunpowder: ',data);});},engineering:function(){$.ajax({type:'GET',url:'php/researchEngineering.php'}).done(function(data){my.tech.engineering=1;research.report(data,"Engineering");});},rocketry:function(){$.ajax({type:'GET',url:'php/researchRocketry.php'}).done(function(data){my.tech.rocketry=1;research.report(data,"Rocketry");}).fail(function(data){console.info('rocketry: ',data);});},atomicTheory:function(){$.ajax({type:'GET',url:'php/researchAtomicTheory.php'}).done(function(data){my.tech.atomicTheory=1;research.report(data,"Atomic Theory");}).fail(function(data){console.info('atomic: ',data);});},futureTech:function(){$.ajax({type:'GET',url:'php/researchFutureTech.php'}).done(function(data){research.report(data,"Future Tech");}).fail(function(data){console.info('future: ',data);});},report:function(data,tech){setProduction(data);game.chat('You have finished researching '+tech+'.');if(data.cultureMsg){game.chat(data.cultureMsg);}
audio.play('research');action.setMenu();}}
$(document).on('keydown',function(e){var x=e.keyCode;if(x===9){if(g.view==='game'){if(!e.shiftKey){my.nextTarget(false);}else{my.nextTarget(true);}
e.preventDefault();}}});$(document).on('keyup',function(e){var x=e.keyCode;if(g.view==='title'){if(x===13){if(g.focusUpdateNationName){title.submitNationName();}else if(g.focusGameName){title.createGame();}else if(title.chatOn){if(x===13){title.sendMsg();}}else if(title.createGameFocus){title.createGame();}}else if(x===27){title.hideBackdrop();}}else if(g.view==='lobby'){if(lobby.chatOn){if(x===13){lobby.sendMsg();}}}else if(g.view==='game'){if(g.chatOn){if(x===13){toggleChatMode(true);}else if(x===27){toggleChatMode();}}else{if(x===13){toggleChatMode();}else if(x===27){my.attackOn=false;my.attackName='';my.clearHud();showTarget(document.getElementById('land'+my.tgt));}else if(x===65){var o=new Target();action.target(o);}else if(x===83){var o=new Target({cost:3,splitAttack:true});action.target(o);}else if(x===68){if(!g.keyLock){action.deploy();}}else if(x===82){if(!g.keyLock){action.recruit();}}else if(x===69){research.engineering();}else if(x===71){research.gunpowder();}else if(x===75){research.rocketry();}else if(x===84){research.atomicTheory();}else if(x===70){research.futureTech();}else if(x===66){action.upgradeTileDefense();}else if(x===67){var o=new Target({cost:40*my.weaponCost,minimum:0,attackName:'cannons',hudMsg:'Fire Cannons'});action.target(o);}else if(x===77){var o=new Target({cost:60*my.weaponCost,minimum:0,attackName:'missile',hudMsg:'Launch Missile'});action.target(o);}else if(x===78){var o=new Target({cost:400*my.weaponCost,minimum:0,attackName:'nuke',hudMsg:'Launch Nuclear Weapon'});action.target(o);}}}});var events={core:(function(){$(window).focus(function(){document.title=g.defaultTitle;g.titleFlashing=false;if(g.notification.close!==undefined){g.notification.close();}});$(window).on('resize orientationchange',function(){resizeWindow();}).on('load',function(){resizeWindow();TweenMax.to("#worldTitle",300,{startAt:{xPercent:-50,yPercent:-50,rotation:-360},rotation:0,repeat:-1,ease:Linear.easeNone});});})(),title:(function(){$("#gameView").on('dragstart','img',function(e){e.preventDefault();});$("img").on('dragstart',function(event){event.preventDefault();});$("#logout").on('click',function(){playerLogout();return false;});$("#titleMenu").on("click",".wars",function(){var gameName=$(this).data("name");$("#joinGameName").val(gameName);$("#joinGamePassword").val('');}).on("dblclick",".wars",function(){var gameName=$(this).data("name");$("#joinGameName").val(gameName);$("#joinGamePassword").val('');title.joinGame();});$("#create").on("click",function(){TweenMax.to(document.getElementById("createGameWrap"),.5,{startAt:{visibility:'visible',scale:.8,alpha:0},scale:1,alpha:1});TweenMax.to(document.getElementById("titleViewBackdrop"),.25,{startAt:{visibility:'visible',opacity:0},opacity:1,ease:Linear.easeNone,onComplete:function(){$("#gameName").focus();}});g.isModalOpen=true;});$("#createGame").on("mousedown",function(e){title.createGame();});$("body").on("click",'#options',function(){TweenMax.to(document.getElementById("optionsModal"),.5,{startAt:{visibility:'visible',scale:.8,alpha:0},scale:1,alpha:1});TweenMax.to(document.getElementById("titleViewBackdrop"),.25,{startAt:{visibility:'visible',opacity:0},opacity:1,ease:Linear.easeNone});g.isModalOpen=true;});$("#optionsDone, #cancelCreateGame").on("click",function(){title.hideBackdrop();});$("#titleMenu").on("click","#joinGame",function(){title.joinGame();});$("#mainWrap").on("click","#cancelGame",function(){exitGame();}).on("click","#startGame",function(){startGame();});$("#toggleNation").on("click",function(){var e=document.getElementById("configureNation"),e2=document.getElementById("titleViewBackdrop");TweenMax.to(e,.5,{startAt:{visibility:'visible',scale:.8,alpha:0},scale:1,alpha:1});TweenMax.to(e2,.5,{startAt:{visibility:'visible',opacity:0},opacity:1});g.isModalOpen=true;});$("#flagDropdown").on('click','.flagSelect',function(e){my.selectedFlag=$(this).text();my.selectedFlagFull=my.selectedFlag==="Nepal"?my.selectedFlag+".png":my.selectedFlag+".jpg";$(".flagPurchaseStatus").css("display","none");$("#updateNationFlag").attr("src","images/flags/"+my.selectedFlagFull).css("display","block");g.lock(1);$.ajax({url:'php/updateFlag.php',data:{flag:my.selectedFlagFull}}).done(function(data){$("#offerFlag").css("display","none");$(".nationFlag").attr({src:"images/flags/"+my.selectedFlagFull,title:my.selectedFlag});$("#flagPurchased").css("display","block");Msg("Your nation's flag is now: "+my.selectedFlag);document.getElementById('selectedFlag').textContent=my.selectedFlag;$("[title]").tooltip('fixTitle');}).fail(function(e){$("#flagPurchased").css("display","none");$("#offerFlag").css("display","block");}).always(function(){g.unlock(1);TweenMax.fromTo("#updateNationFlag",1,{alpha:.25,scale:.9},{alpha:1,scale:1});});e.preventDefault();});$("#submitNationName").on("mousedown",function(){title.submitNationName();});$("#updateNationName").on("focus",function(){g.focusUpdateNationName=true;}).on("blur",function(){g.focusUpdateNationName=false;});$("#refreshGameWrap").on("focus","#gameName",function(){g.focusGameName=true;})
$("#refreshGameWrap").on("blur","#gameName",function(){g.focusGameName=false;});$("#buyFlag").on("click",function(){g.lock();$.ajax({url:'php/buyFlag.php',data:{flag:my.selectedFlagFull}}).done(function(data){$("#crystalCount").text(data);$("#flagPurchased").css("display","block");$("#offerFlag").css("display","none");$(".nationFlag").attr({src:"images/flags/"+my.selectedFlagFull,title:my.selectedFlag});Msg("Your nation's flag is now: "+my.selectedFlag);document.getElementById('selectedFlag').textContent=my.selectedFlag;$("[title]").tooltip('fixTitle');}).fail(function(e){Msg(e.statusText);}).always(function(){g.unlock();});});$("#titleViewBackdrop").on('click',function(){title.hideBackdrop();});$("#configureNationDone").on('click',function(){audio.play('click');title.hideBackdrop();});})(),lobby:(function(){$("#lobby-chat-input").on('focus',function(){lobby.chatOn=true;}).on('blur',function(){lobby.chatOn=false;});$("#lobbyChatSend").on('click',function(){lobby.sendMsg(true);});$("#lobbyChatLog").on('mousedown',function(){lobby.chatDrag=true;}).on('mouseup',function(){lobby.chatDrag=false;});$("#joinGameLobby").on('click','.governmentChoice',function(e){var government=$(this).text();lobby.updateGovernmentWindow(government);$.ajax({url:"php/changeGovernment.php",data:{government:government}});e.preventDefault();});})(),map:(function(){if(!isFirefox){$("body").on("mousewheel",function(e){if(g.view!=='title'){setMousePosition(e.offsetX,e.offsetY);worldMap[0].applyBounds();}});$("#worldWrap").on("mousewheel",function(e){e.originalEvent.wheelDelta>0?mouseZoomIn(e):mouseZoomOut(e);worldMap[0].applyBounds();});}else{$("body").on("DOMMouseScroll",function(e){if(g.view!=='title'){setMousePosition(e.originalEvent.layerX,e.originalEvent.layerY);worldMap[0].applyBounds();}});$("#worldWrap").on("DOMMouseScroll",function(e){e.originalEvent.detail>0?mouseZoomOut(e):mouseZoomIn(e);worldMap[0].applyBounds();});}
$("#worldWrap").on("mousemove",function(e){if(isFirefox){setMousePosition(e.originalEvent.layerX,e.originalEvent.layerY);}else{setMousePosition(e.offsetX,e.offsetY);}});$("#diplomacy-ui").on('click','#surrender',function(e){exitGame();});$("#createGameWrap").on('click','.mapSelect',function(e){var x=$(this).text();var key=x.replace(/ /g,'');g.map.name=x;g.map.key=key;document.getElementById('createGameMap').innerHTML=x;document.getElementById('createGameTiles').innerHTML=title.mapData[key].tiles;document.getElementById('createGamePlayers').innerHTML=title.mapData[key].players;e.preventDefault();});})(),map:(function(){$("#bgmusic").on('ended',function(){var x=document.getElementById('bgmusic');x.currentTime=0;x.play();});$("#bgamb1").on('ended',function(){var x=document.getElementById('bgamb1');x.currentTime=0;x.play();});$("#bgamb2").on('ended',function(){var x=document.getElementById('bgamb2');x.currentTime=0;x.play();});})()}
var animate={nationName:function(){var tl=new TimelineMax();var split=new SplitText("#nationName",{type:"words,chars"});var chars=split.chars;tl.staggerFromTo(chars,.05,{immediateRender:true,alpha:0},{delay:.25,alpha:1},.016);},randomColor:function(){var x=~~(Math.random()*6),c='#ffffff';if(x===0){c='#ffffaa';}else if(x===1){c='#ffddaa';}else if(x===2){c='#ffeedd';}else if(x===3){c='#eeeecc';}else if(x===4){c='#ffbb77';}
return c;},getXY:function(tile){var e2=document.getElementById('unit'+tile),box=e2.getBBox(),o={x:box.x,y:box.y}
return o;},upgrade:function(tile){audio.play('build');var e1=document.getElementById('unit'+tile),box=e1.getBBox();var x=box.x+box.width/2-10;var y=box.y+box.height/2+10;var size=game.tiles[tile].defense-game.tiles[tile].capital?1:0;for(var i=1;i<=(3+(size*3));i++){var svg=document.createElementNS('http://www.w3.org/2000/svg','image');svg.setAttributeNS(null,'height',256);svg.setAttributeNS(null,'width',256);svg.setAttributeNS(null,"x",x);svg.setAttributeNS(null,"y",y);svg.setAttributeNS('http://www.w3.org/1999/xlink','xlink:href','images/goldSmoke.png');DOM.mapAnimations.appendChild(svg);TweenMax.to(svg,.5,{startAt:{xPercent:-50,yPercent:-50,transformOrigin:'50% 50%',opacity:1,scale:0},scale:i*.1,opacity:0,onComplete:function(){this.target.parentNode.removeChild(this.target);}});}
var shield=document.createElementNS("http://www.w3.org/2000/svg","image");shield.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href","images/bulwark.png");shield.setAttributeNS(null,"width",28);shield.setAttributeNS(null,"height",32);shield.setAttributeNS(null,"x",x);shield.setAttributeNS(null,"y",y);DOM.mapAnimations.appendChild(shield);TweenMax.to(shield,.5,{startAt:{xPercent:-50,yPercent:-50,transformOrigin:'50% 50%',opacity:1,scale:.1},scale:1,ease:Back.easeOut.config(3)});TweenMax.to(shield,1.5,{y:'-=30'});TweenMax.to(shield,.5,{delay:1.5,opacity:0,onComplete:function(){this.target.parentNode.removeChild(this.target);}});this.updateMapBars(tile);},updateMapBars:function(tile){var e1=document.getElementById('unit'+tile),box=e1.getBBox(),x=box.x+box.width/2-10,y=box.y+box.height/2+10;$(".mapBars"+tile).remove();this.initMapBars(tile,x,y);console.info("UPDATING MAP BARS");},initMapBars:function(i,x,y){var e=document.getElementById('unit'+i);var x=e.getAttribute('x')-24;var y=e.getAttribute('y')-24;var boxHeight=6;if(game.tiles[i].culture){boxHeight+=4;}
if(game.tiles[i].defense){boxHeight+=4;}
var boxOpacity=game.tiles[i].player?1:0;var foodWidth=game.tiles[i].food*3;if(foodWidth>24){foodWidth=24;}
x+=4
var svg=document.createElementNS('http://www.w3.org/2000/svg','rect');svg.setAttributeNS(null,'width',26);svg.setAttributeNS(null,'height',boxHeight);svg.setAttributeNS(null,"x",x);svg.setAttributeNS(null,"y",y+26);svg.setAttributeNS(null,"fill","#2a2a2a");svg.setAttributeNS(null,"stroke","#000000");svg.setAttributeNS(null,"opacity",boxOpacity);svg.setAttributeNS(null,"class","mapBars"+i);DOM.mapBars.appendChild(svg);y+=29;x+=1
var svg=document.createElementNS('http://www.w3.org/2000/svg','line');svg.setAttributeNS(null,"x1",x);svg.setAttributeNS(null,"y1",y);svg.setAttributeNS(null,"x2",x+foodWidth);svg.setAttributeNS(null,"y2",y);svg.setAttributeNS(null,"stroke","#88dd00");svg.setAttributeNS(null,"stroke-width","3");svg.setAttributeNS(null,"opacity",boxOpacity);svg.setAttributeNS(null,"class","mapBars mapBars"+i);DOM.mapBars.appendChild(svg);if(game.tiles[i].culture){y+=4;var cultureWidth=game.tiles[i].culture*3;if(cultureWidth>24){cultureWidth=24;}
var svg=document.createElementNS('http://www.w3.org/2000/svg','line');svg.setAttributeNS(null,"x1",x);svg.setAttributeNS(null,"y1",y);svg.setAttributeNS(null,"x2",x+cultureWidth);svg.setAttributeNS(null,"y2",y);svg.setAttributeNS(null,"stroke","#dd22dd");svg.setAttributeNS(null,"stroke-width","3");svg.setAttributeNS(null,"opacity",boxOpacity);svg.setAttributeNS(null,"class","mapBars mapBars"+i);DOM.mapBars.appendChild(svg);}
if(game.tiles[i].defense){y+=4;var defWidth=game.tiles[i].defense*6;var svg=document.createElementNS('http://www.w3.org/2000/svg','line');svg.setAttributeNS(null,"x1",x);svg.setAttributeNS(null,"y1",y);svg.setAttributeNS(null,"x2",x+defWidth);svg.setAttributeNS(null,"y2",y);svg.setAttributeNS(null,"stroke","#ffff00");svg.setAttributeNS(null,"stroke-width","3");svg.setAttributeNS(null,"opacity",boxOpacity);svg.setAttributeNS(null,"class","mapBars mapBars"+i);DOM.mapBars.appendChild(svg);}},gunfire:function(tile,playSound){var e1=document.getElementById('land'+tile),box=e1.getBBox();var sfx=~~(Math.random()*9);var delay=[.5,.5,.33,.33,.33,.33,.8,.33,.66,.4];if(playSound){audio.play('machine'+sfx);}
var x=0,y=0;for(var i=0;i<50;i++){(function(Math){var circ=document.createElementNS("http://www.w3.org/2000/svg","circle");x=box.x+(Math.random()*(box.width*.8))+box.width*.1;y=box.y+(Math.random()*(box.height*.8))+box.height*.1;circ.setAttributeNS(null,"cx",x);circ.setAttributeNS(null,"cy",y);circ.setAttributeNS(null,"r",6);circ.setAttributeNS(null,"fill",animate.randomColor());circ.setAttributeNS(null,"stroke",'#000');DOM.world.appendChild(circ);TweenMax.to(circ,.125,{delay:Math.random()*delay[sfx],startAt:{opacity:1},attr:{r:0,},onComplete:function(){this.target.parentNode.removeChild(this.target);}});})(Math);}
animate.smoke(tile,x,y,.5);},cannons:function(tile,playSound){var e1=document.getElementById('land'+tile),box=e1.getBBox();if(playSound){var a=[5,6,8];var sfx=~~(Math.random()*3);audio.play('grenade'+a[sfx]);}
var x=0,y=0;for(var i=0;i<20;i++){(function(Math){var circ=document.createElementNS("http://www.w3.org/2000/svg","circle");x=box.x+(Math.random()*(box.width*.8))+box.width*.1;y=box.y+(Math.random()*(box.height*.8))+box.height*.1;circ.setAttributeNS(null,"cx",x);circ.setAttributeNS(null,"cy",y);circ.setAttributeNS(null,"r",16);circ.setAttributeNS(null,"fill",'#ffff55');circ.setAttributeNS(null,"stroke","#ffff55");DOM.mapAnimations.appendChild(circ);var delay=i*.015;TweenMax.to(circ,.3,{delay:delay,attr:{r:4},onUpdate:function(){TweenMax.set(circ,{fill:animate.randomColor()});},onComplete:function(){this.target.parentNode.removeChild(this.target);}});TweenMax.to(circ,.3,{delay:delay,startAt:{opacity:1},opacity:0});})(Math);}
animate.smoke(tile,x,y,.7);},missile:function(attacker,defender,playSound){if(playSound){audio.play('missile7');}
var e2=document.getElementById('unit'+attacker),boxA=e2.getBBox(),x1=boxA.x+boxA.width/2,y1=boxA.y+boxA.height/2,e3=document.getElementById('unit'+defender),boxB=e3.getBBox(),x2=boxB.x+boxB.width/2,y2=boxB.y+boxB.height/2;my.motionPath[0]=e2.getAttribute('x')*1-10;my.motionPath[1]=e2.getAttribute('y')*1-10;my.motionPath[4]=e3.getAttribute('x')*1-10;my.motionPath[5]=e3.getAttribute('y')*1-10;my.motionPath[2]=(my.motionPath[0]+my.motionPath[4])/ 2;my.motionPath[3]=((my.motionPath[1]+my.motionPath[5])/ 2)-(Math.abs(x1-x2)/3);TweenMax.set(DOM.motionPath,{ease:Circ.easeIn,attr:{d:"M "+my.motionPath[0]+","+my.motionPath[1]+' '+
					+my.motionPath[4]+" "+my.motionPath[5]}});var path=MorphSVGPlugin.pathDataToBezier('#motionPath',{align:'relative'});var mis=document.createElementNS("http://www.w3.org/2000/svg","image");mis.setAttributeNS(null,"width",30);mis.setAttributeNS(null,"height",5);mis.setAttributeNS(null,"x",x1);mis.setAttributeNS(null,"y",y1);mis.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href","images/missile.png");DOM.mapAnimations.appendChild(mis);var count=0;TweenMax.to(mis,1.5,{startAt:{opacity:1,xPercent:-50,yPercent:-50},bezier:{values:path,type:'cubic',curviness:1.5,autoRotate:true},ease:Power2.easeIn,onUpdate:function(){count++;if(count%5===0){var x=x1+mis._gsTransform.x;var y=y1+mis._gsTransform.y;var svg=document.createElementNS('http://www.w3.org/2000/svg','image');svg.setAttributeNS(null,'height',40);svg.setAttributeNS(null,'width',40);svg.setAttributeNS(null,"x",x);svg.setAttributeNS(null,"y",y);svg.setAttributeNS('http://www.w3.org/1999/xlink','xlink:href','images/smoke.png');DOM.mapAnimations.appendChild(svg);TweenMax.to(svg,.5,{startAt:{xPercent:-50,yPercent:-50,transformOrigin:'50% 50%',opacity:0},opacity:1,scale:1.5,ease:Power3.easeOut,onComplete:function(){TweenMax.to(this.target,.5,{opacity:0,scale:2,ease:Linear.easeNone,onComplete:function(){this.target.parentNode.removeChild(this.target);}});}});}},onComplete:function(){this.target.parentNode.removeChild(this.target);animate.missileExplosion(defender);}});},missileExplosion:function(tile){var e1=document.getElementById('unit'+tile),box=e1.getBBox(),a=[5,6,8],sfx=~~(Math.random()*3);audio.play('grenade'+a[sfx]);var x=0,y=0;for(var i=0;i<5;i++){(function(Math){var circ=document.createElementNS("http://www.w3.org/2000/svg","circle");x=box.x+Math.random()*60-30;y=box.y+Math.random()*60-30;circ.setAttributeNS(null,"cx",x);circ.setAttributeNS(null,"cy",y);circ.setAttributeNS(null,"r",0);circ.setAttributeNS(null,"fill",animate.randomColor());circ.setAttributeNS(null,"stroke",'#ffffaa');DOM.mapAnimations.appendChild(circ);var delay=i*.05;TweenMax.to(circ,.75,{delay:delay,attr:{r:32},onComplete:function(){TweenMax.to(circ,.5,{attr:{r:16},ease:Power1.easeIn,onComplete:function(){this.target.parentNode.removeChild(this.target);},});},ease:Power4.easeOut});TweenMax.to(circ,1.25,{startAt:{opacity:1},opacity:0,onUpdate:function(){TweenMax.set(circ,{fill:animate.randomColor()});},ease:Power2.easeIn});})(Math);}
animate.smoke(tile,x,y,1);},nuke:function(tile){var e2=document.getElementById('unit'+tile),box=e2.getBBox();var x=box.x;var y=box.y;shadow=document.createElementNS("http://www.w3.org/2000/svg","ellipse");shadow.setAttributeNS(null,"cx",x);shadow.setAttributeNS(null,"cy",y);shadow.setAttributeNS(null,"rx",2);shadow.setAttributeNS(null,"ry",1);shadow.setAttributeNS(null,"fill",'#000000');shadow.setAttributeNS(null,"stroke",'none');DOM.mapAnimations.appendChild(shadow);TweenMax.to(shadow,1,{startAt:{opacity:.5},attr:{rx:10,ry:5},ease:Power1.easeIn,onComplete:function(){this.target.parentNode.removeChild(this.target);}});var bomb=document.createElementNS("http://www.w3.org/2000/svg","image");bomb.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href","images/nuke.png");bomb.setAttributeNS(null,"width",16);bomb.setAttributeNS(null,"height",12);bomb.setAttributeNS(null,"x",x-6);bomb.setAttributeNS(null,"y",y-g.screen.height);DOM.mapAnimations.appendChild(bomb);TweenMax.to(bomb,1,{attr:{y:y},ease:Power1.easeIn,onComplete:function(){this.target.parentNode.removeChild(this.target);}});new Image('images/smoke.png');TweenMax.to(g,1,{onComplete:function(){audio.play('bomb9');TweenMax.to(DOM.screenFlash,.1,{startAt:{opacity:1,background:'#ffffff'},opacity:0,background:'#ff8800',ease:Expo.easeOut});animate.screenShake(16,10,.016,true);var circ=document.createElementNS("http://www.w3.org/2000/svg","circle");circ.setAttributeNS(null,"cx",x);circ.setAttributeNS(null,"cy",y);circ.setAttributeNS(null,"r",1);circ.setAttributeNS(null,"fill",'#ffaa00');circ.setAttributeNS(null,"stroke",'#ffffaa');DOM.mapAnimations.appendChild(circ);TweenMax.to(circ,1.5,{startAt:{opacity:1},attr:{r:80},onComplete:function(){TweenMax.to(circ,1,{attr:{r:50},ease:Power1.easeIn});},ease:Power3.easeOut});TweenMax.to(circ,2.5,{onUpdate:function(){TweenMax.set(circ,{fill:animate.randomColor()});}});TweenMax.to(circ,2.5,{opacity:0,ease:Power4.easeIn,onComplete:function(){this.target.parentNode.removeChild(this.target);}});animate.smoke(tile,x,y);}});},smoke:function(tile,x,y,scale){if(x===undefined){var o=animate.getXY(tile);x=o.x;y=o.y;}
if(scale===undefined){scale=1.25;}
var smoke=document.createElementNS("http://www.w3.org/2000/svg","image");smoke.setAttributeNS(null,"width",256);smoke.setAttributeNS(null,"height",256);smoke.setAttributeNS(null,"x",x);smoke.setAttributeNS(null,"y",y);smoke.setAttributeNS(null,"opacity",0);smoke.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href","images/smoke.png");DOM.mapUpgrades.appendChild(smoke);TweenMax.to(smoke,3,{startAt:{opacity:1,transformOrigin:'50% 50%',xPercent:-50,yPercent:-50,scale:0},ease:Power4.easeOut,scale:scale});TweenMax.to(smoke,3,{opacity:0,onComplete:function(){this.target.parentNode.removeChild(this.target);}});},screenShake:function(count,d,interval,fade){var foo=0;var M=Math;(function doit(count,d,interval){var d2=d/2;if(fade){if(foo%2===0){d--;if(d<2){d=2;}}}
TweenMax.to(DOM.world,interval,{x:~~(M.random()*(d)-d2),y:~~(M.random()*(d)-d2),onComplete:function(){TweenMax.to(DOM.world,interval,{x:~~(M.random()*(d)-d2),y:~~(M.random()*(d)-d2),onComplete:function(){TweenMax.to(DOM.world,interval,{x:~~(M.random()*(d)-d2),y:~~(M.random()*(d)-d2),onComplete:function(){TweenMax.to(DOM.world,interval,{x:0,y:0,onComplete:function(){foo++;if(foo<count){doit(count,d,interval);}}});}});}});}});})(count,d,interval);},water:function(){var delay=130,delay2=10,e1=document.getElementById('worldWater1'),e2=document.getElementById('worldWater2'),e3=document.getElementById('worldWater3');TweenMax.to(e1,delay,{backgroundPosition:'-800px 0px',repeat:-1,ease:Linear.easeNone});TweenMax.to(e2,delay,{startAt:{backgroundPosition:'400px 300px'},backgroundPosition:'1200px 300px',repeat:-1,ease:Linear.easeNone});TweenMax.to(e3,delay,{startAt:{backgroundPosition:'200px 150px',},backgroundPosition:'200px -650px',repeat:-1,yoyo:true,ease:Linear.easeNone});},glowTile:function(oldTgt,newTgt){var e1=document.getElementById('land'+oldTgt),e2=document.getElementById('land'+newTgt);TweenMax.set(e1,{stroke:'#66ccff',filter:'',strokeWidth:1});TweenMax.set(e2,{stroke:'#aaeeff',filter:'url(#glow)',strokeWidth:2});game.updateTopTile(newTgt);}}
function Stats(){var o={overview:{score:0,unitScore:0,structureScore:0,weaponScore:0,resourceScore:0},units:{produced:0,killed:0,lost:0},structures:{bunkers:0,walls:0,fortresses:0},weapons:{cannons:0,missiles:0,nukes:0},resources:{food:0,culture:0,energy:0}}
return o;}})($,Math,document,location);